import{w as ce,V as le,r as y,ae as me,j as s,B as d,b as pe,T as c,I as J,a6 as S,d as I,at as ue,au as ye,av as he,a7 as ge,M as Q,aw as be}from"./index-BJkBHIXD.js";import{f as xe}from"./state-DFemdeiH.js";import{f as _e}from"./severity-Bb8Qe9go.js";import{f as fe}from"./department-BOJZtc9U.js";import{C as je}from"./Card-CU8jzKuK.js";import{C as De}from"./Chip-Cd7PxQUv.js";import{S as ve}from"./Stack-DSqJGNfN.js";import{F as Te,S as Se}from"./Select-CM-FquqI.js";const Me=["dateTime","subject","description","files","reportingChannel","category","assignedTo","reportingMedium","department","severity","state"],z=b=>Me.reduce((i,h)=>(i[h]=!b.includes(h),i),{});function Fe({caseId:b}){const{t:i}=ce("navbar"),{user:h}=le(),[a,F]=y.useState(null),[Y,R]=y.useState(!0),[N,$]=y.useState([]),[w,B]=y.useState([]),[V,P]=y.useState([]),[X,U]=y.useState(()=>z([])),[j,D]=y.useState({category:"",assignedTo:"Not Assigned",reportingMedium:"",department:"",severity:"",state:""}),[E,H]=y.useState({}),[Z,W]=y.useState({}),[_,M]=y.useState({department:"",severity:"",state:""});y.useEffect(()=>{b&&(async()=>{try{R(!0);const e=await ue(b);if(!e){F(null),U(z([]));return}const p=Array.isArray(e.hidden_fields)?e.hidden_fields:[];U(z(p));const x=await ye(),l=h?.role==="case_manager"?h?.company_id||e.company_id:e.company_id||h?.company_id;let C=[];if(l&&(C=await he(l)),l)try{const[f,ae,se]=await Promise.all([fe({per_page:1e3,company_id:l}),_e({per_page:1e3,company_id:l}),xe({per_page:1e3,company_id:l})]),re=m=>m?.company_id??m?.companyId??m?.company?.id??m?.company?.company_id??m?.company?.companyId??null,q=l?String(l).toLowerCase():null,k=m=>m.filter(oe=>{const G=re(oe);return q?G?String(G).toLowerCase()===q:!1:!0}),ie=k(f.data?.data??[]).map(m=>({id:m.id,name:m.name})),ne=k(ae.data?.data??[]).map(m=>({id:m.id,name:m.name})),de=k(se.data?.data??[]).map(m=>({id:m.id,name:m.name}));$(ie),B(ne),P(de)}catch(f){console.error("Failed to fetch company-specific options:",f)}else $([]),B([]),P([]);F({id:e.id,caseId:e.case_id,dateTime:e.created_at,subject:e.subject,description:e.description,category:e.category||"N/A",category_id:e.category_id||null,reportingMedium:e.reporting_medium||"N/A",department:e.department_name||"N/A",department_id:e.department_id||null,severity:e.severity_name||"N/A",severity_id:e.severity_id||null,state:e.state_name||"N/A",state_id:e.state_id||null,assignedTo:e.case_manager_name||"Not Assigned",case_manager_id:e.case_manager_id||null,report_type:e.report_type||null,status:e.status||null,open_deadline_time:e.open_deadline_time||null,close_deadline_time:e.close_deadline_time||null,other_report_link:e.other_report_link||null,automatic_delete:e.automatic_delete||null}),M({department:e.department_name||"",severity:e.severity_name||"",state:e.state_name||""});const v=x.find(f=>f.name===e.category||f.id===e.category_id),L=v?v.name:e.category||"",T=C.find(f=>f.name===e.case_manager_name||f.id===e.case_manager_id),n=T?T.name:e.case_manager_name||"Not Assigned",u=[i("dashboard.case.caseDetailsTab.written"),i("dashboard.case.caseDetailsTab.phoneCall"),i("dashboard.case.caseDetailsTab.physicalMeeting")],o={written:i("dashboard.case.caseDetailsTab.written"),oral:i("dashboard.case.caseDetailsTab.written"),phone_call:i("dashboard.case.caseDetailsTab.phoneCall"),phone:i("dashboard.case.caseDetailsTab.phoneCall"),physical_meeting:i("dashboard.case.caseDetailsTab.physicalMeeting"),physical:i("dashboard.case.caseDetailsTab.physicalMeeting")}[e.reporting_medium?.toLowerCase()||""]||e.reporting_medium,A=o&&u.includes(o)?o:o||"",te={category:L,assignedTo:n,reportingMedium:A,department:e.department_id||"",severity:e.severity_id||"",state:e.state_id||""};D(te)}catch(e){console.error("Error fetching data:",e),F(null)}finally{R(!1)}})()},[b,h?.company_id,h?.role,i]),y.useEffect(()=>{if(!(!a||Y)){if(N.length>0){let t;a.department_id?t=N.find(e=>e.id===a.department_id):a.department&&a.department!=="N/A"&&(t=N.find(e=>e.name===a.department)),t&&j.department!==t.id&&D(e=>({...e,department:t?.id??""})),t&&_.department!==t.name&&M(e=>({...e,department:t?.name??e.department}))}if(w.length>0){let t;a.severity_id?t=w.find(e=>e.id===a.severity_id):a.severity&&a.severity!=="N/A"&&(t=w.find(e=>e.name===a.severity)),t&&j.severity!==t.id&&D(e=>({...e,severity:t?.id??""})),t&&_.severity!==t.name&&M(e=>({...e,severity:t?.name??e.severity}))}if(V.length>0){let t;a.state_id?t=V.find(e=>e.id===a.state_id):a.state&&a.state!=="N/A"&&(t=V.find(e=>e.name===a.state)),t&&j.state!==t.id&&D(e=>({...e,state:t?.id??""})),t&&_.state!==t.name&&M(e=>({...e,state:t?.name??e.state}))}}},[N,w,V,a,Y,j.department,j.severity,j.state,_.department,_.severity,_.state]),y.useEffect(()=>{if(b&&!Y&&a)try{me(b,"Tab Viewed","Case Details Tab (Backend)")}catch(t){console.error("Failed to log tab view:",t)}},[b,Y,a]);const O=h?.role==="admin"||h?.role==="company"||h?.role==="case_manager";if(Y)return s.jsx(d,{sx:{display:"flex",justifyContent:"center",alignItems:"center",minHeight:200},children:s.jsx(pe,{})});if(!a)return s.jsx(d,{sx:{display:"flex",justifyContent:"center",alignItems:"center",minHeight:200},children:s.jsx(c,{color:"error",children:i("dashboard.case.caseDetailsTab.failedToLoad")})});const K=["department","severity","state"],ee=async(t,e)=>{if(!O)return;const p=j[t];if(!K.includes(t)){D(n=>({...n,[t]:e}));return}const l={department:N,severity:w,state:V}[t].find(n=>n.id===e||n.name===e);D(n=>({...n,[t]:e}));const C={department:"department_id",severity:"severity_id",state:"state_id"};if(H(n=>({...n,[t]:e})),["department","severity","state"].includes(t)){const n=t;M(u=>({...u,[n]:l?.name??u[n]}))}W(n=>({...n,[t]:l?.name??e}));const v=C[t],L=e||null,T={[v]:L};try{const n=await be(b,T);F(r=>{if(!r)return r;const o=`${t}_name`,A=`${t}_id`;return{...r,[t]:n?.data?.[o]??"N/A",[A]:n?.data?.[A]??null}});const u=n?.data?.[`${t}_id`]??null;if(D(r=>({...r,[t]:u||e||""})),["department","severity","state"].includes(t)){const r=t;M(o=>({...o,[r]:n?.data?.[`${t}_name`]??o[r]}))}H(r=>{const o={...r};return delete o[t],o}),W(r=>{const o={...r};return delete o[t],o})}catch(n){console.error(`Failed to update case ${t}:`,n),D(u=>({...u,[t]:p})),H(u=>{const r={...u};return delete r[t],r}),W(u=>{const r={...u};return delete r[t],r})}},g=(t,e,p,x=!1,l=[])=>{const C=(E[p]??j[p])||"",v=E[p]?Z[p]:void 0,L=l.length>0&&typeof l[0]=="object",T=p==="department"?_.department:p==="severity"?_.severity:p==="state"?_.state:"",n=()=>s.jsx(c,{variant:"body2",color:"text.secondary",children:i("dashboard.case.caseDetailsTab.select")}),u=r=>{if(!r)return n();if(v&&E[p]===r)return v;if(L){const o=l.find(A=>A.id===r);return o?o.name:T||(e&&e!=="N/A"?e:n())}return r||(e&&e!=="N/A"?e:n())};return s.jsxs(d,{children:[s.jsxs(d,{sx:{display:"flex",alignItems:x?"flex-start":"center",gap:1,py:x?2:1.5,flexDirection:x?"column":"row"},children:[s.jsxs(d,{sx:{display:"flex",alignItems:"center",gap:1,width:x?"100%":"auto",mb:x?1:0},children:[s.jsx(c,{variant:"subtitle2",color:"text.secondary",sx:{minWidth:120},children:t}),O&&s.jsx(ge,{size:"small",disabled:!0,sx:{p:.5,cursor:"default"},"aria-label":`Toggle ${t} visibility`,children:s.jsx(J,{icon:X[p]===!0?"material-symbols:visibility-off":"material-symbols:visibility",sx:{fontSize:16}})})]}),s.jsx(d,{sx:{flex:1,width:x?"100%":"auto"},children:x&&O?s.jsx(Te,{size:"medium",sx:{minWidth:280,width:"100%",maxWidth:400,"& .MuiOutlinedInput-root":{borderRadius:"8px",backgroundColor:"background.paper","&:hover .MuiOutlinedInput-notchedOutline":{borderColor:"primary.main"},"&.Mui-focused .MuiOutlinedInput-notchedOutline":{borderColor:"primary.main",borderWidth:2}}},children:s.jsx(Se,{value:C,onChange:r=>ee(p,r.target.value),displayEmpty:!0,sx:{height:48,fontSize:"0.95rem","& .MuiSelect-select":{padding:"12px 14px"}},renderValue:r=>typeof r!="string"||r===""?n():u(r),children:l.length===0?s.jsx(Q,{value:"",disabled:!0,children:s.jsx(c,{variant:"body2",color:"text.secondary",children:i("dashboard.case.caseDetailsTab.loading")})}):l.map(r=>s.jsx(Q,{value:typeof r=="string"?r:r.id,sx:{fontSize:"0.95rem"},children:typeof r=="string"?r:r.name},typeof r=="string"?r:r.id))})}):s.jsx(c,{variant:"body1",children:e})})]}),s.jsx(S,{sx:{borderStyle:"dashed"}})]})};return s.jsxs(je,{sx:{p:3},children:[s.jsxs(d,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:3},children:[s.jsx(c,{variant:"h6",sx:{fontWeight:"bold"},children:i("dashboard.case.caseDetails")}),a?.report_type==="report_annonymously"&&s.jsx(De,{label:"Anonymous",size:"small",sx:{bgcolor:"grey.100",color:"text.secondary","& .MuiChip-icon":{fontSize:16}},icon:s.jsx(J,{icon:"solar:shield-check-bold"})})]}),s.jsxs(ve,{spacing:1,children:[s.jsxs(d,{children:[s.jsxs(d,{sx:{display:"flex",alignItems:"center",gap:1,py:1.5},children:[s.jsxs(c,{variant:"subtitle2",color:"text.secondary",sx:{minWidth:120},children:[i("dashboard.case.caseDetailsTab.caseId"),":"]}),s.jsx(c,{variant:"body1",sx:{fontFamily:"monospace"},children:b})]}),s.jsx(S,{sx:{borderStyle:"dashed"}})]}),g(i("dashboard.case.caseDetailsTab.dateTime"),a.dateTime,"dateTime"),g(i("dashboard.case.caseDetailsTab.subject"),a.subject,"subject"),g(i("dashboard.case.caseDetailsTab.description"),a.description,"description"),g(i("dashboard.case.caseDetailsTab.files"),"No files","files"),g(i("dashboard.case.caseDetailsTab.reportingChannel"),"Default","reportingChannel"),g(i("dashboard.case.caseDetailsTab.assignedTo"),a.assignedTo||"Not Assigned","assignedTo"),a.status&&s.jsxs(d,{children:[s.jsxs(d,{sx:{display:"flex",alignItems:"center",gap:1,py:1.5},children:[s.jsxs(c,{variant:"subtitle2",color:"text.secondary",sx:{minWidth:120},children:[i("dashboard.case.reportSettingTab.assignStatus"),":"]}),s.jsx(c,{variant:"body1",children:i(`dashboard.case.reportSettingTab.${a.status==="in_progress"?"inProgress":a.status}`)||a.status})]}),s.jsx(S,{sx:{borderStyle:"dashed"}})]}),a.category&&a.category!=="N/A"&&g(i("dashboard.case.caseDetailsTab.category"),a.category,"category"),a.reportingMedium&&a.reportingMedium!=="N/A"&&g(i("dashboard.case.caseDetailsTab.reportingMedium"),a.reportingMedium,"reportingMedium"),a.department&&a.department!=="N/A"&&g(i("dashboard.case.caseDetailsTab.department"),a.department,"department"),a.severity&&a.severity!=="N/A"&&g(i("dashboard.case.caseDetailsTab.severity"),a.severity,"severity"),a.state&&a.state!=="N/A"&&g(i("dashboard.case.caseDetailsTab.state"),a.state,"state"),a.open_deadline_time&&(()=>{const t=I(a.open_deadline_time,"DD-MM-YYYY hh:mm A"),e=t.isValid()?t.format("YYYY-MM-DD HH:mm"):I(a.open_deadline_time).isValid()?I(a.open_deadline_time).format("YYYY-MM-DD HH:mm"):a.open_deadline_time;return s.jsxs(d,{children:[s.jsxs(d,{sx:{display:"flex",alignItems:"center",gap:1,py:1.5},children:[s.jsxs(c,{variant:"subtitle2",color:"text.secondary",sx:{minWidth:120},children:[i("dashboard.case.reportSettingTab.nextOpenStateDeadline"),":"]}),s.jsx(c,{variant:"body1",children:e})]}),s.jsx(S,{sx:{borderStyle:"dashed"}})]})})(),a.close_deadline_time&&(()=>{const t=I(a.close_deadline_time,"DD-MM-YYYY hh:mm A"),e=t.isValid()?t.format("YYYY-MM-DD HH:mm"):I(a.close_deadline_time).isValid()?I(a.close_deadline_time).format("YYYY-MM-DD HH:mm"):a.close_deadline_time;return s.jsxs(d,{children:[s.jsxs(d,{sx:{display:"flex",alignItems:"center",gap:1,py:1.5},children:[s.jsxs(c,{variant:"subtitle2",color:"text.secondary",sx:{minWidth:120},children:[i("dashboard.case.reportSettingTab.nextCloseStateDeadline"),":"]}),s.jsx(c,{variant:"body1",children:e})]}),s.jsx(S,{sx:{borderStyle:"dashed"}})]})})(),a.other_report_link&&s.jsxs(d,{children:[s.jsxs(d,{sx:{display:"flex",alignItems:"center",gap:1,py:1.5},children:[s.jsxs(c,{variant:"subtitle2",color:"text.secondary",sx:{minWidth:120},children:[i("dashboard.case.reportSettingTab.linkWithOtherReport"),":"]}),s.jsx(c,{variant:"body1",children:a.other_report_link})]}),s.jsx(S,{sx:{borderStyle:"dashed"}})]}),a.automatic_delete&&s.jsxs(d,{children:[s.jsxs(d,{sx:{display:"flex",alignItems:"center",gap:1,py:1.5},children:[s.jsxs(c,{variant:"subtitle2",color:"text.secondary",sx:{minWidth:120},children:[i("dashboard.case.reportSettingTab.autoDeleteAfter30Days"),":"]}),s.jsx(c,{variant:"body1",children:a.automatic_delete==="yes"||a.automatic_delete===!0?i("dashboard.case.reportSettingTab.yes"):i("dashboard.case.reportSettingTab.no")})]}),s.jsx(S,{sx:{borderStyle:"dashed"}})]})]})]})}export{Fe as C};
