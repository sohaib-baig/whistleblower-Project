import{w as se,V as re,r as i,ax as ae,ae as S,ay as te,j as s,B as c,T as g,ag as N,a7 as v,I as y,c as H,ah as A,az as oe,aA as ie,aB as ne,al as O,P as le}from"./index-BJkBHIXD.js";import{p as de}from"./audio-processor-BGEu5NX3.js";import{C as ce}from"./Card-CU8jzKuK.js";import{S as h}from"./Stack-DSqJGNfN.js";import{T as pe}from"./TextField-BfOXJaKd.js";import{C as ge}from"./Chip-Cd7PxQUv.js";function fe({caseId:n}){const{t:o}=se("navbar"),{user:p}=re(),[M,b]=i.useState([]),[C,U]=i.useState(""),[x,L]=i.useState(!1),[V,z]=i.useState(0),[u,R]=i.useState(null),[$,k]=i.useState(null),[q,P]=i.useState(!0),[Y,F]=i.useState(!1),f=i.useRef(null),j=i.useRef([]),E=i.useRef(null),B=i.useRef(null),D=i.useRef(null),I="https://portal.wisling.com",w=i.useCallback(e=>e.startsWith("http")?e:`${I}${e}`,[I]),T=i.useCallback(async(e=!1)=>{try{e&&P(!0);const l=(await ae(n)).map(a=>{const t=a.created_by&&p?.id&&a.created_by===p.id,d=a.type!=="text"?w(a.message):a.message,m=a.creator?.name||a.sender||o(t?"dashboard.case.legalSupportTab.you":"dashboard.case.legalSupportTab.partner");return{id:a.id,message:a.type==="text"?a.message:a.type==="audio"?o("dashboard.case.legalSupportTab.audioMessage"):`${o("dashboard.case.legalSupportTab.imageMessage")}: ${a.message.split("/").pop()}`,sender:m,timestamp:a.timestamp?new Date(a.timestamp).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):"",type:t?"user":"system",messageType:a.type,audioUrl:a.type==="audio"?d:void 0,imageUrl:a.type==="image"?d:void 0,imageName:a.type==="image"?a.message.split("/").pop():void 0}});if(b(l),e){try{await S(n,"Tab Viewed","Legal Support Tab (Backend)")}catch(a){console.error("Failed to log legal support tab view:",a)}try{await te(n),window.dispatchEvent(new CustomEvent("legalSupportMessagesMarkedAsRead",{detail:{caseId:n}})),setTimeout(()=>{window.dispatchEvent(new CustomEvent("legalSupportMessagesMarkedAsRead",{detail:{caseId:n}}))},500)}catch(a){console.error("Failed to mark legal support messages as read:",a)}}}catch(r){console.error("Error fetching legal support messages:",r),e&&b([])}finally{e&&P(!1)}},[n,w,o,p?.id]);i.useEffect(()=>{n&&T(!0)},[n,T]),i.useEffect(()=>{if(!n)return;const e=setInterval(()=>{T(!1)},3e3);return()=>clearInterval(e)},[n,T]),i.useEffect(()=>{B.current?.scrollIntoView({behavior:"smooth"})},[M]);const W=async()=>{const e=C.trim();if(e&&!(e.length>1e4))try{const r=await oe(n,e),l=r.created_by&&p?.id&&r.created_by===p.id,a={id:r.id,message:r.message,sender:p?.name||o("dashboard.case.legalSupportTab.you"),timestamp:r.timestamp?new Date(r.timestamp).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):"",type:l?"user":"system",messageType:r.type};b(t=>[...t,a]),U("");try{await S(n,"Legal Support Message Sent",`Text message: ${e.substring(0,100)}${e.length>100?"...":""}`)}catch(t){console.error("Failed to log legal support message:",t)}}catch(r){console.error("Error sending legal support message:",r)}},G=e=>{e.key==="Enter"&&!e.shiftKey&&(e.preventDefault(),W())},J=async()=>{try{const e=await navigator.mediaDevices.getUserMedia({audio:!0}),r={},l=["audio/webm","audio/webm;codecs=opus","audio/ogg;codecs=opus","audio/mp4","audio/wav"];for(const t of l)if(MediaRecorder.isTypeSupported(t)){r.mimeType=t;break}const a=new MediaRecorder(e,r);f.current=a,j.current=[],a.ondataavailable=t=>{t.data&&t.data.size>0&&j.current.push(t.data)},a.onstop=async()=>{let t=a.mimeType||"audio/webm";if(t.includes(";")&&(t=t.split(";")[0]),t.startsWith("audio/")||(t="audio/webm"),j.current.length===0){e.getTracks().forEach(m=>m.stop());return}const d=new Blob(j.current,{type:t});e.getTracks().forEach(m=>m.stop());try{F(!0);const m=await de(d);K(m)}catch(m){console.error("Error processing audio:",m),K(d)}finally{F(!1)}},a.start(1e3),L(!0),z(0),E.current=setInterval(()=>{z(t=>t+1)},1e3)}catch(e){console.error("Error accessing microphone:",e)}},_=()=>{if(f.current&&x)try{f.current.state==="recording"&&f.current.requestData(),f.current.stop(),L(!1),E.current&&clearInterval(E.current)}catch(e){console.error("Error stopping recording:",e)}},K=async e=>{try{if(e.size>10*1024*1024)return;const r=await ie(n,e),l=w(r.message),a=r.created_by&&p?.id&&r.created_by===p.id,t={id:r.id,message:`${o("dashboard.case.legalSupportTab.audioMessage")} (${Math.round(e.size/1024)}KB)`,sender:p?.name||o("dashboard.case.legalSupportTab.you"),timestamp:r.timestamp?new Date(r.timestamp).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):"",type:a?"user":"system",messageType:r.type,audioUrl:l};b(d=>[...d,t]);try{await S(n,"Legal Support Message Sent",`Audio message (${Math.round(e.size/1024)}KB)`)}catch(d){console.error("Failed to log legal support audio message:",d)}}catch(r){console.error("Error sending legal support audio message:",r)}},Q=e=>{const r=Math.floor(e/60),l=e%60;return`${r}:${l.toString().padStart(2,"0")}`},X=e=>{const r=e.target.files?.[0];if(r&&r.type.startsWith("image/")){R(r);const l=new FileReader;l.onload=a=>{k(a.target?.result)},l.readAsDataURL(r)}},Z=async()=>{if(u)try{if(u.size>10*1024*1024||!["image/jpeg","image/jpg","image/png","image/gif","image/webp"].includes(u.type))return;const r=await ne(n,u),l=w(r.message),a=r.created_by&&p?.id&&r.created_by===p.id,t={id:r.id,message:`${o("dashboard.case.legalSupportTab.imageMessage")}: ${u.name}`,sender:p?.name||o("dashboard.case.legalSupportTab.you"),timestamp:r.timestamp?new Date(r.timestamp).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):"",type:a?"user":"system",messageType:r.type,imageUrl:l,imageName:u.name};b(d=>[...d,t]),R(null),k(null);try{await S(n,"Legal Support Message Sent",`Image: ${u.name}`)}catch(d){console.error("Failed to log legal support image message:",d)}}catch(e){console.error("Error sending legal support image message:",e)}},ee=e=>s.jsxs(h,{direction:"row",spacing:2,justifyContent:e.type==="user"?"flex-end":"flex-start",sx:{mb:2},children:[e.type!=="user"&&s.jsx(O,{sx:{width:32,height:32},children:s.jsx(y,{icon:"solar:user-id-bold"})}),s.jsx(le,{sx:{p:2,maxWidth:"70%",backgroundColor:e.type==="user"?"primary.main":"grey.100",color:e.type==="user"?"primary.contrastText":"text.primary"},children:s.jsxs(h,{spacing:1,children:[s.jsxs(h,{direction:"row",spacing:1,alignItems:"center",justifyContent:"space-between",children:[s.jsx(g,{variant:"caption",sx:{fontWeight:600,opacity:e.type==="user"?.9:.8,fontSize:"0.75rem"},children:e.sender}),s.jsx(ge,{size:"small",label:e.messageType==="audio"?o("dashboard.case.legalSupportTab.voice"):e.messageType==="image"?o("dashboard.case.legalSupportTab.imageMessage"):o("dashboard.case.legalSupportTab.text"),icon:s.jsx(y,{icon:e.messageType==="audio"?"solar:microphone-bold":e.messageType==="image"?"solar:gallery-add-bold":"solar:chat-round-dots-bold",width:14}),sx:{fontSize:"0.7rem",height:20,backgroundColor:e.type==="user"?"rgba(255,255,255,0.2)":"rgba(0,0,0,0.1)",color:e.type==="user"?"white":"text.secondary"}})]}),e.messageType==="audio"&&e.audioUrl?s.jsxs(c,{children:[s.jsxs("audio",{controls:!0,style:{width:"100%",maxWidth:"300px"},children:[s.jsx("source",{src:e.audioUrl,type:"audio/wav"}),"Your browser does not support the audio element."]}),s.jsx(g,{variant:"caption",sx:{display:"block",mt:.5,opacity:.7},children:e.message})]}):e.messageType==="image"&&e.imageUrl?s.jsxs(c,{children:[s.jsx("img",{src:e.imageUrl,alt:e.imageName||"Uploaded image",style:{maxWidth:"300px",maxHeight:"200px",borderRadius:"8px",objectFit:"cover"}}),s.jsx(g,{variant:"caption",sx:{display:"block",mt:.5,opacity:.7},children:e.message})]}):s.jsx(g,{variant:"body2",sx:{whiteSpace:"pre-wrap"},children:e.message}),s.jsx(g,{variant:"caption",sx:{display:"block",opacity:.7},children:e.timestamp})]})}),e.type==="user"&&s.jsx(O,{sx:{width:32,height:32},children:s.jsx(y,{icon:"solar:user-id-bold"})})]},e.id);return s.jsxs(ce,{sx:{height:"70vh",display:"flex",flexDirection:"column"},children:[s.jsx(c,{sx:{p:2,borderBottom:1,borderColor:"divider"},children:s.jsx(h,{direction:"row",alignItems:"center",justifyContent:"space-between",children:s.jsx(g,{variant:"h6",children:o("dashboard.case.legalSupportTab.heading")})})}),s.jsx(c,{sx:{flex:1,overflow:"auto",p:2},children:q?s.jsx(c,{sx:{display:"flex",justifyContent:"center",alignItems:"center",minHeight:200},children:s.jsx(g,{variant:"body2",color:"text.secondary",children:o("dashboard.case.legalSupportTab.loadingMessages")})}):M.length===0?s.jsx(c,{sx:{display:"flex",justifyContent:"center",alignItems:"center",minHeight:200},children:s.jsx(g,{variant:"body2",color:"text.secondary",children:o("dashboard.case.legalSupportTab.noMessages")})}):s.jsxs(s.Fragment,{children:[M.map(ee),s.jsx("div",{ref:B})]})}),s.jsxs(c,{sx:{p:2,borderTop:1,borderColor:"divider"},children:[x&&s.jsx(c,{sx:{mb:2},children:s.jsxs(h,{direction:"row",spacing:2,alignItems:"center",children:[s.jsxs(c,{sx:{display:"flex",alignItems:"center",gap:1},children:[s.jsx(c,{sx:{width:12,height:12,borderRadius:"50%",backgroundColor:"error.main",animation:"pulse 1.5s infinite","@keyframes pulse":{"0%":{opacity:1},"50%":{opacity:.5},"100%":{opacity:1}}}}),s.jsxs(g,{variant:"body2",color:"error.main",children:[o("dashboard.case.legalSupportTab.recording")," ",Q(V)]})]}),s.jsx(N,{sx:{flex:1}}),s.jsx(v,{color:"error",onClick:_,size:"small",children:s.jsx(y,{icon:"solar:copy-bold"})})]})}),Y&&s.jsx(c,{sx:{mb:2},children:s.jsxs(h,{direction:"row",spacing:2,alignItems:"center",children:[s.jsx(N,{sx:{flex:1}}),s.jsx(g,{variant:"body2",color:"text.secondary",children:o("dashboard.case.legalSupportTab.processingAudio")||"Processing audio..."})]})}),$&&s.jsx(c,{sx:{mb:2,p:2,border:1,borderColor:"divider",borderRadius:1},children:s.jsxs(h,{direction:"row",spacing:2,alignItems:"center",children:[s.jsx("img",{src:$,alt:"Preview",style:{width:"60px",height:"60px",objectFit:"cover",borderRadius:"4px"}}),s.jsxs(c,{sx:{flex:1},children:[s.jsx(g,{variant:"body2",color:"text.secondary",children:u?.name}),s.jsxs(g,{variant:"caption",color:"text.secondary",children:[(u?.size||0)/1024," KB"]})]}),s.jsxs(h,{direction:"row",spacing:1,children:[s.jsx(H,{size:"small",onClick:Z,variant:"contained",children:o("dashboard.case.legalSupportTab.send")}),s.jsx(H,{size:"small",onClick:()=>{R(null),k(null)},children:o("dashboard.case.legalSupportTab.cancel")})]})]})}),s.jsxs(h,{direction:"row",spacing:1,children:[s.jsx(pe,{fullWidth:!0,placeholder:o("dashboard.case.legalSupportTab.typeMessagePlaceholder"),value:C,onChange:e=>U(e.target.value),onKeyPress:G,variant:"outlined",size:"small",multiline:!0,maxRows:3}),s.jsx(A,{title:o("dashboard.case.legalSupportTab.attachImage"),children:s.jsx(v,{color:"default",onClick:()=>D.current?.click(),children:s.jsx(y,{icon:"solar:gallery-add-bold"})})}),s.jsx(A,{title:o(x?"dashboard.case.legalSupportTab.stopRecording":"dashboard.case.legalSupportTab.startRecording"),children:s.jsx(v,{color:x?"error":"default",onClick:x?_:J,children:s.jsx(y,{icon:x?"solar:copy-bold":"solar:microphone-bold"})})}),s.jsx(A,{title:o("dashboard.case.legalSupportTab.sendMessage"),children:s.jsx(v,{color:"primary",onClick:W,disabled:!C.trim(),children:s.jsx(y,{icon:"custom:send-fill"})})})]}),s.jsx("input",{ref:D,type:"file",accept:"image/*",onChange:X,style:{display:"none"}})]})]})}export{fe as L};
