import{r as h,j as e,B as n,b as C,T as d,bt as M,i as y,s as j,A as S,J as ae,K as Y,c as F,P as te,x as se}from"./index-BJkBHIXD.js";import"./new-password-icon-DzJdOKvQ.js";import{l as H}from"./text-transform-DM798QSo.js";import"./styles-B-zEs6qR.js";import{Q as ne}from"./account-change-password-DsljHT40.js";import{C as R}from"./Card-CU8jzKuK.js";import{C as z}from"./CardContent-B8WUz70H.js";import{S as J}from"./Stack-DSqJGNfN.js";import{T as le}from"./TextField-BfOXJaKd.js";import"./Select-CM-FquqI.js";import"./format-number-BErDzwe7.js";import"./rhf-phone-input-DvY4aKGv.js";import"./index.esm-DG78EUPk.js";import"./index-CDpvdXdB.js";import"./search-not-found-BYtFGFNz.js";import"./InputAdornment-Cyf39fZQ.js";import"./schema-utils-C_-d4BNQ.js";import"./schemas-BaSQ7w8v.js";import"./zod-DbnPk1Kl.js";import"./fields-wQ2IQIfM.js";import"./index-BdCJuPE0.js";import"./rhf-text-field-D45rQogC.js";import"./RadioGroup-eX8WPtuC.js";import"./FormControlLabel-Do9AncA_.js";import"./Autocomplete-vOabT0lM.js";import"./Chip-Cd7PxQUv.js";import"./rhf-select-BCHEEYe2.js";import"./upload-default-BMHhCMpu.js";import"./tslib.es6-CTYbIaVE.js";import"./DatePicker-D3hVcc_W.js";import"./form-provider-BYLnCB41.js";function ie(){const[a,r]=h.useState(null),[m,$]=h.useState(!0),[l,E]=h.useState(!1),[w,v]=h.useState("email"),[G,c]=h.useState(null),[O,i]=h.useState(null),[u,b]=h.useState(!1),[k,_]=h.useState(""),[Q,U]=h.useState(!1),[f,W]=h.useState(null),[I,B]=h.useState(null),[P,D]=h.useState(""),[V,L]=h.useState(!1),g=async()=>{try{$(!0),c(null),await y();const t=(await j.get("/api/v1/profile/2fa"))?.data;t&&typeof t=="object"?(r({enabled:!!t.enabled,method:t.method||null,has_secret:!!t.has_secret}),t.method==="app"?v("app"):v("email")):r({enabled:!1,method:null,has_secret:!1})}catch(s){console.error("❌ Failed to load 2FA status:",s);const t=s?.response?.data?.message||s?.message||"Failed to load two-factor authentication status.";c(t),r({enabled:!1,method:null,has_secret:!1})}finally{$(!1)}};h.useEffect(()=>{g()},[]);const K=(s,t)=>{v(t),c(null),i(null)},X=async()=>{try{U(!0),c(null),i(null),await y(),await j.post("/api/v1/profile/2fa/send-email-code",{reason:"enable"}),i("Verification code has been sent to your email.")}catch(s){const t=s?.response?.data?.message||s?.message||"Failed to send verification code.";c(t)}finally{U(!1)}},Z=async()=>{try{L(!0),c(null),i(null),await y();const t=(await j.post("/api/v1/profile/2fa/setup-app"))?.data;t?.secret&&t?.otpauth_url?(W(t.secret),B(t.otpauth_url),i("Scan the QR code or enter the secret into your authenticator app, then enter a code to enable 2FA.")):(console.error("❌ Invalid response structure:",t),c("Invalid response from server. Please try again."))}catch(s){console.error("❌ Setup app error:",s);const t=s?.response?.data?.message||s?.message||"Failed to generate authenticator app secret.";c(t)}finally{L(!1)}},N=async()=>{try{E(!0),c(null),i(null);const s=w,t=s==="email"?k:P;if(!t||t.length<6){c("Please enter a valid 6-digit code."),E(!1);return}const o=a?.enabled&&a?.method&&a.method!==s;if(o)try{await y(),await j.post("/api/v1/profile/2fa/disable")}catch(ee){console.error("Failed to disable previous method:",ee)}await y();const x=(await j.post("/api/v1/profile/2fa/enable",{method:s,code:t}))?.data;!x||!x.method?r({enabled:!0,method:s,has_secret:s==="app"?!!f:!1}):r({enabled:!0,method:x.method,has_secret:x.method==="app"?!!f:!1});const T=s==="app"?"authenticator app":"email codes",q=s==="app"?"email codes":"authenticator app";i(o?`Two-factor authentication has been enabled using ${T}. ${q.charAt(0).toUpperCase()+q.slice(1)} 2FA has been automatically disabled.`:`Two-factor authentication has been enabled using ${T}.`),_(""),D(""),await g()}catch(s){const t=s?.response?.data?.message||s?.message||"Failed to enable two-factor authentication.";c(t)}finally{E(!1)}},A=async s=>{try{E(!0),c(null),i(null),a?.enabled&&a?.method===s&&(await y(),await j.post("/api/v1/profile/2fa/disable"),r({enabled:!1,method:null,has_secret:!1}),W(null),B(null),_(""),D(""),i("Two-factor authentication has been disabled.")),await g()}catch(t){const o=t?.response?.data?.message||t?.message||"Failed to disable two-factor authentication.";c(o)}finally{E(!1)}};return m?e.jsx(n,{sx:{display:"flex",alignItems:"center",justifyContent:"center",minHeight:200},children:e.jsx(C,{size:32})}):e.jsxs(n,{children:[e.jsx(R,{sx:{mb:3},children:e.jsx(z,{children:e.jsxs(J,{direction:"row",alignItems:"center",justifyContent:"space-between",spacing:2,children:[e.jsxs(n,{children:[e.jsx(d,{variant:"h6",children:"Two-Factor Authentication"}),e.jsx(d,{variant:"body2",color:"text.secondary",children:a?.enabled?`Currently enabled using ${a.method==="app"?"authenticator app":"email codes"}`:"Add an extra layer of security to your account"})]}),e.jsxs(n,{sx:{display:"flex",alignItems:"center",gap:1,cursor:l||m||u?"not-allowed":"pointer"},children:[e.jsx(d,{variant:"body2",sx:{minWidth:60},children:a?.enabled?"Enabled":"Disabled"}),e.jsx(M,{checked:!!a?.enabled,disabled:l||m||u,onChange:async s=>{if(l||m||u)return;const t=!!a?.enabled,o=a;if(t){r({enabled:!1,method:null,has_secret:!1}),b(!0);try{await y(),await j.post("/api/v1/profile/2fa/disable"),await g(),W(null),B(null),_(""),D(""),i("Two-factor authentication has been disabled.")}catch(p){o&&r(o);const x=p?.response?.data?.message||p?.message||"Failed to disable two-factor authentication.";c(x),await g()}finally{b(!1)}}else{const p=a?.method==="app"?"app":"email";r({enabled:!0,method:p,has_secret:p==="app"?!!f:!1}),b(!0),c(null),i(null),w===p?(v(p==="email"?"app":"email"),setTimeout(()=>{v(p),i(`Please complete the setup below to enable 2FA using ${p==="app"?"authenticator app":"email codes"}.`),b(!1),setTimeout(()=>{const T=document.querySelector('[role="tabpanel"]');T&&T.scrollIntoView({behavior:"smooth",block:"start"})},100)},150)):(v(p),i(`Please complete the setup below to enable 2FA using ${p==="app"?"authenticator app":"email codes"}.`),b(!1),setTimeout(()=>{const x=document.querySelector('[role="tabpanel"]');x&&x.scrollIntoView({behavior:"smooth",block:"start"})},200))}}}),u&&e.jsx(C,{size:16,sx:{ml:1}})]})]})})}),!!G&&e.jsx(S,{severity:"error",sx:{mb:2},children:G}),!!O&&e.jsx(S,{severity:"success",sx:{mb:2},onClose:()=>i(null),children:O}),e.jsxs(ae,{value:w,onChange:K,sx:{mb:3},"aria-label":"Two-factor authentication method",children:[e.jsx(Y,{label:"Email code",value:"email"}),e.jsx(Y,{label:"Authenticator app",value:"app"})]}),e.jsxs(n,{children:[w==="email"&&e.jsx(R,{children:e.jsx(z,{children:e.jsxs(n,{sx:{display:"flex",flexDirection:"column",gap:3},children:[e.jsxs(n,{sx:{display:"flex",justifyContent:"space-between",alignItems:"flex-start"},children:[e.jsxs(n,{sx:{flex:1},children:[e.jsx(d,{variant:"subtitle1",sx:{mb:1,fontWeight:600},children:"Email Code Authentication"}),e.jsx(d,{variant:"body2",color:"text.secondary",children:"Receive a one-time code via email when you sign in. You will need to enter this code in addition to your password."})]}),e.jsxs(n,{sx:{display:"flex",alignItems:"center",gap:1,cursor:l||m||u?"not-allowed":"pointer",ml:2},children:[e.jsx(d,{variant:"body2",sx:{minWidth:60},children:a?.enabled&&a?.method==="email"?"Enabled":"Disabled"}),e.jsx(M,{checked:a?.enabled&&a?.method==="email",disabled:l||m||u,onChange:async s=>{if(l||m||u)return;const t=a?.enabled&&a?.method==="email",o=a;if(t)await A("email");else if(r({enabled:!0,method:"email",has_secret:!1}),o?.enabled&&o?.method==="app")try{b(!0),await A("app"),await g(),r({enabled:!0,method:"email",has_secret:!1}),i("Please complete the setup below to enable Email 2FA.")}catch{o&&r(o)}finally{b(!1)}else i("Please complete the setup below to enable Email 2FA.")}}),(l||u)&&e.jsx(C,{size:16,sx:{ml:1}})]})]}),a?.enabled&&a?.method==="email"?e.jsxs(n,{sx:{display:"flex",flexDirection:"column",gap:2},children:[e.jsx(S,{severity:"success",children:"Two-factor authentication is enabled using email codes."}),e.jsx(F,{variant:"outlined",color:"error",onClick:()=>A("email"),disabled:l,sx:{alignSelf:"flex-start"},children:l?"Disabling...":"Disable Email 2FA"})]}):a?.enabled&&a?.method==="app"?e.jsx(S,{severity:"info",children:"Authenticator app 2FA is currently enabled. Enabling Email 2FA will automatically disable Authenticator app 2FA."}):e.jsxs(e.Fragment,{children:[e.jsx(n,{sx:{p:2,border:"1px solid",borderColor:"divider",borderRadius:1,backgroundColor:"background.default"},children:e.jsxs(J,{direction:"row",spacing:2,alignItems:"center",children:[e.jsx(F,{variant:"contained",onClick:X,disabled:Q,sx:{minWidth:140},children:Q?e.jsxs(e.Fragment,{children:[e.jsx(C,{size:16,sx:{mr:1},color:"inherit"}),"Sending..."]}):"Send code"}),e.jsx(d,{variant:"body2",color:"text.secondary",sx:{flex:1},children:"We will send a 6-digit verification code to your account email."})]})}),e.jsxs(n,{children:[e.jsx(d,{variant:"body2",sx:{mb:1.5,fontWeight:500},children:"Enter verification code"}),e.jsx(H,{length:6,value:k,onChange:_,TextFieldsProps:{placeholder:"‒",inputMode:"numeric"}})]}),e.jsx(F,{variant:"contained",onClick:N,disabled:l||!k||k.length!==6,size:"large",fullWidth:!0,children:l?"Enabling...":"Enable 2FA with email"})]})]})})}),w==="app"&&e.jsx(R,{children:e.jsx(z,{children:e.jsxs(n,{sx:{display:"flex",flexDirection:"column",gap:3},children:[e.jsxs(n,{sx:{display:"flex",justifyContent:"space-between",alignItems:"flex-start"},children:[e.jsxs(n,{sx:{flex:1},children:[e.jsx(d,{variant:"subtitle1",sx:{mb:1,fontWeight:600},children:"Authenticator App"}),e.jsx(d,{variant:"body2",color:"text.secondary",children:"Use an authenticator app (such as Google Authenticator, Microsoft Authenticator, or Authy) to generate time-based codes when you sign in."})]}),e.jsxs(n,{sx:{display:"flex",alignItems:"center",gap:1,cursor:l||m||u?"not-allowed":"pointer",ml:2},children:[e.jsx(d,{variant:"body2",sx:{minWidth:60},children:a?.enabled&&a?.method==="app"?"Enabled":"Disabled"}),e.jsx(M,{checked:a?.enabled&&a?.method==="app",disabled:l||m||u,onChange:async s=>{if(l||m||u)return;const t=a?.enabled&&a?.method==="app",o=a;if(t)await A("app");else if(r({enabled:!0,method:"app",has_secret:!!f}),o?.enabled&&o?.method==="email")try{b(!0),await A("email"),await g(),r({enabled:!0,method:"app",has_secret:!!f}),i("Please complete the setup below to enable Authenticator App 2FA.")}catch{o&&r(o)}finally{b(!1)}else i("Please complete the setup below to enable Authenticator App 2FA.")}}),(l||u)&&e.jsx(C,{size:16,sx:{ml:1}})]})]}),a?.enabled&&a?.method==="app"?e.jsxs(n,{sx:{display:"flex",flexDirection:"column",gap:2},children:[e.jsx(S,{severity:"success",children:"Two-factor authentication is enabled using authenticator app."}),e.jsx(F,{variant:"outlined",color:"error",onClick:()=>A("app"),disabled:l,sx:{alignSelf:"flex-start"},children:l?"Disabling...":"Disable Authenticator App 2FA"})]}):a?.enabled&&a?.method==="email"?e.jsx(S,{severity:"info",children:"Email code 2FA is currently enabled. Enabling Authenticator app 2FA will automatically disable Email 2FA."}):e.jsx(F,{variant:"contained",onClick:Z,disabled:V,sx:{alignSelf:"flex-start",minWidth:180},children:V?e.jsxs(e.Fragment,{children:[e.jsx(C,{size:16,sx:{mr:1},color:"inherit"}),"Generating..."]}):f?"Regenerate secret":"Generate secret"}),f&&e.jsxs(n,{sx:{display:"flex",flexDirection:"column",gap:2},children:[I&&e.jsx(n,{sx:{display:"flex",flexDirection:"column",alignItems:"center",gap:2},children:e.jsxs(te,{elevation:2,sx:{p:2,display:"flex",flexDirection:"column",alignItems:"center",gap:1,backgroundColor:"background.paper"},children:[e.jsx(d,{variant:"subtitle2",sx:{mb:1},children:"Scan this QR code with your authenticator app"}),e.jsx(n,{sx:{p:2,backgroundColor:"white",borderRadius:1,display:"flex",alignItems:"center",justifyContent:"center"},children:e.jsx(ne,{value:I,size:200,level:"M"})})]})}),e.jsx(le,{label:"Secret key",value:f,InputProps:{readOnly:!0},fullWidth:!0,helperText:"You can manually enter this secret key if you cannot scan the QR code"}),I&&e.jsxs(d,{variant:"caption",color:"text.secondary",sx:{wordBreak:"break-all"},children:["Or use this URL: ",I]})]}),f&&!a?.enabled&&e.jsxs(e.Fragment,{children:[e.jsxs(n,{children:[e.jsx(d,{variant:"body2",sx:{mb:1.5,fontWeight:500},children:"Enter verification code from your authenticator app"}),e.jsx(d,{variant:"body2",color:"text.secondary",sx:{mb:2},children:"After adding the secret to your authenticator app, enter a 6-digit code from the app to confirm and enable 2FA."}),e.jsx(H,{length:6,value:P,onChange:D,TextFieldsProps:{placeholder:"‒",inputMode:"numeric"}})]}),e.jsx(F,{variant:"contained",onClick:N,disabled:l||!P||P.length!==6,size:"large",fullWidth:!0,children:l?"Enabling...":"Enable 2FA with authenticator app"})]})]})})})]},w)]})}function oe(){return e.jsx(ie,{})}const re={title:`Account two-factor authentication | Dashboard - ${se.appName}`};function Ge(){return e.jsxs(e.Fragment,{children:[e.jsx("title",{children:re.title}),e.jsx(oe,{})]})}export{Ge as default};
