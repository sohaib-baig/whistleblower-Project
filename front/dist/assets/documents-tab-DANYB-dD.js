import{w as re,r as o,j as e,B as U,b as M,T as w,I as v,c as h,ab as ce,a7 as le,X as W,Y as H,Z as N,A as ie,_ as q,aq as P,ae as k,a0 as c,ar as de,as as me}from"./index-BJkBHIXD.js";import"./styles-B-zEs6qR.js";import{U as ue}from"./upload-default-BMHhCMpu.js";import"./empty-content-Cck_Y1yy.js";import{T as he}from"./table-head-custom-C2dATJUG.js";import{T as pe}from"./table-pagination-custom-Dom7EZhX.js";import{C as V}from"./Card-CU8jzKuK.js";import{S as y}from"./Stack-DSqJGNfN.js";import{T as fe}from"./TextField-BfOXJaKd.js";import{I as be}from"./InputAdornment-Cyf39fZQ.js";import{T as xe}from"./TableContainer-D0zNvGRU.js";import{b as ge,c as Te,T as X,a as x}from"./TableHead-D9jAElFw.js";function _e({caseId:r}){const{t:a}=re("navbar"),[_,Y]=o.useState(""),[S,B]=o.useState(0),[g,Z]=o.useState(5),[G,L]=o.useState(!1),[p,T]=o.useState([]),[A,E]=o.useState([]),[J,R]=o.useState(!0),[f,z]=o.useState(!1),[K,j]=o.useState(!1),[C,I]=o.useState(null),[m,i]=o.useState({}),Q=[{id:"title",label:a("dashboard.case.documentsTab.title")},{id:"document",label:a("dashboard.case.documentsTab.document")},{id:"uploadedAt",label:a("dashboard.case.documentsTab.uploadedAt")},{id:"actions",label:a("dashboard.case.documentsTab.actions")}];o.useEffect(()=>{r&&(async()=>{try{R(!0);const s=await P(r);E(s);try{await k(r,"Tab Viewed","Documents Tab (Backend)")}catch(n){console.error("Failed to log tab view:",n)}}catch(s){console.error("Error fetching attachments:",s),c.error(s.message||a("dashboard.case.documentsTab.failedToLoad"))}finally{R(!1)}})()},[r,a]);const F=A.filter(t=>t.attachment_name.toLowerCase().includes(_.toLowerCase())),ee=()=>{L(!0)},$=()=>{f||(L(!1),T([]),i({}))},ae=async()=>{if(i({}),p.length===0){i({file:a("dashboard.case.documentsTab.fileRequired")}),c.error(a("dashboard.case.documentsTab.pleaseSelectFile"));return}const t=["pdf","doc","docx","xls","xlsx","ppt","pptx","txt","jpg","jpeg","png","gif"],s=[],n=[];if(p.forEach(l=>{l.size>10*1024*1024&&n.push(l.name);const d=l.name.split(".").pop()?.toLowerCase();(!d||!t.includes(d))&&s.push(l.name)}),n.length>0){i({file:a("dashboard.case.documentsTab.fileSizeExceeded")}),c.error(`${a("dashboard.case.documentsTab.fileSizeMaxExceeded")}: ${n.join(", ")}`);return}if(s.length>0){i({file:a("dashboard.case.documentsTab.invalidFileType")}),c.error(`${a("dashboard.case.documentsTab.invalidFileTypeError")}: ${s.join(", ")}`);return}z(!0);let b=0,D=0;try{for(const d of p)try{const u=d.name,O=(u.substring(0,u.lastIndexOf("."))||u).trim()||u;await de(r,d,O);try{await k(r,"Document Uploaded",`Document: ${O} (${d.name})`)}catch(ne){console.error("Failed to log document upload:",ne)}b++}catch(u){console.error(`Failed to upload ${d.name}:`,u),D++}const l=await P(r);E(l),b>0&&c.success(`${b} ${b===1?"document":"documents"} uploaded successfully`),D>0&&c.error(`${D} ${D===1?"document":"documents"} failed to upload`),b>0&&$()}catch(l){c.error(l.message||a("dashboard.case.documentsTab.failedToUpload"))}finally{z(!1)}},te=t=>{I(t),j(!0)},se=async()=>{if(C)try{const t=A.find(n=>n.id===C);await me(C);try{await k(r,"Document Deleted",t?`Document: ${t.attachment_name}`:`Document ID: ${C}`)}catch(n){console.error("Failed to log document delete:",n)}const s=await P(r);E(s),c.success(a("dashboard.case.documentsTab.deletedSuccessfully"))}catch(t){c.error(t.message||a("dashboard.case.documentsTab.failedToDelete"))}j(!1),I(null)},oe=t=>{window.open(t.attachment_path,"_blank")};return J?e.jsx(V,{children:e.jsx(U,{sx:{p:3,display:"flex",justifyContent:"center",alignItems:"center",minHeight:200},children:e.jsx(M,{})})}):e.jsxs(e.Fragment,{children:[e.jsx(V,{children:e.jsxs(U,{sx:{p:3},children:[e.jsxs(y,{direction:"row",alignItems:"center",justifyContent:"space-between",sx:{mb:3},children:[e.jsx(w,{variant:"h6",children:a("dashboard.case.documentsTab.heading")}),e.jsxs(y,{direction:"row",spacing:2,children:[e.jsx(fe,{value:_,onChange:t=>Y(t.target.value),placeholder:a("dashboard.case.documentsTab.searchPlaceholder"),InputProps:{startAdornment:e.jsx(be,{position:"start",children:e.jsx(v,{icon:"eva:search-fill"})})},sx:{width:300}}),e.jsx(h,{variant:"contained",startIcon:e.jsx(v,{icon:"solar:add-circle-bold"}),onClick:ee,children:a("dashboard.case.documentsTab.newDocument")})]})]}),e.jsx(xe,{sx:{position:"relative",overflow:"unset"},children:e.jsx(ce,{children:e.jsxs(ge,{children:[e.jsx(he,{headCells:Q}),e.jsx(Te,{children:F.length===0?e.jsx(X,{children:e.jsx(x,{colSpan:4,align:"center",children:e.jsx(w,{variant:"body2",color:"text.secondary",children:A.length===0?a("dashboard.case.documentsTab.noDocumentsFound"):a("dashboard.case.documentsTab.noDocumentsMatchSearch")})})}):F.slice(S*g,S*g+g).map(t=>e.jsxs(X,{hover:!0,children:[e.jsx(x,{children:t.attachment_name}),e.jsx(x,{children:e.jsxs(h,{variant:"text",startIcon:e.jsx(v,{icon:"solar:download-bold"}),onClick:()=>oe(t),children:[t.attachment_type.toUpperCase()," ",a("dashboard.case.documentsTab.file")]})}),e.jsx(x,{children:t.created_at||"N/A"}),e.jsx(x,{children:e.jsx(y,{direction:"row",spacing:1,children:e.jsx(le,{size:"small",onClick:()=>te(t.id),color:"error",children:e.jsx(v,{icon:"solar:trash-bin-trash-bold"})})})})]},t.id))})]})})}),e.jsx(pe,{page:S,count:F.length,rowsPerPage:g,onPageChange:(t,s)=>B(s),onRowsPerPageChange:t=>{Z(parseInt(t.target.value,10)),B(0)}})]})}),e.jsxs(W,{open:G,onClose:$,maxWidth:"sm",fullWidth:!0,children:[e.jsx(H,{children:a("dashboard.case.documentsTab.uploadNewDocument")}),e.jsx(N,{children:e.jsxs(y,{spacing:3,sx:{pt:2},children:[e.jsx(w,{variant:"body2",color:"text.secondary",sx:{mb:1},children:a("dashboard.case.documentsTab.selectMultipleFiles","Select one or more files to upload. File names will be used as document titles.")}),e.jsx(ue,{multiple:!0,accept:{"image/*":[".jpg",".jpeg",".png",".gif"],"application/pdf":[".pdf"],"application/msword":[".doc"],"application/vnd.openxmlformats-officedocument.wordprocessingml.document":[".docx"],"application/vnd.ms-excel":[".xls"],"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet":[".xlsx"],"application/vnd.ms-powerpoint":[".ppt"],"application/vnd.openxmlformats-officedocument.presentationml.presentation":[".pptx"],"text/plain":[".txt"]},value:p,onDrop:t=>{T(t),m.file&&i({...m,file:void 0})},onRemove:t=>{T(s=>s.filter(n=>n!==t))},onRemoveAll:()=>{T([]),m.file&&i({...m,file:void 0})}}),m.file&&e.jsx(ie,{severity:"error",sx:{mt:1},children:m.file})]})}),e.jsxs(q,{children:[e.jsx(h,{onClick:$,disabled:f,children:a("dashboard.case.documentsTab.close")}),e.jsx(h,{variant:"contained",onClick:ae,disabled:f||p.length===0,startIcon:f?e.jsx(M,{size:20}):null,children:a(f?"dashboard.case.documentsTab.uploading":"dashboard.case.documentsTab.upload")})]})]}),e.jsxs(W,{open:K,onClose:()=>j(!1),children:[e.jsx(H,{children:a("dashboard.case.documentsTab.deleteConfirmTitle")}),e.jsx(N,{children:e.jsx(w,{children:a("dashboard.case.documentsTab.deleteConfirmMessage")})}),e.jsxs(q,{children:[e.jsx(h,{onClick:()=>j(!1),children:a("dashboard.case.documentsTab.close")}),e.jsx(h,{variant:"contained",color:"error",onClick:se,children:a("dashboard.case.documentsTab.delete")})]})]})]})}export{_e as D};
