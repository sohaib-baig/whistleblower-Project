import{w as te,r as o,j as e,B as I,b as se,T as j,I as C,c as u,ab as oe,a7 as _,X as $,Y as H,Z as q,_ as z,am as re,ae as N,a0 as l,an as ne,ao as ie,ap as le}from"./index-BJkBHIXD.js";import"./empty-content-Cck_Y1yy.js";import{T as de}from"./table-head-custom-C2dATJUG.js";import{T as ce}from"./table-pagination-custom-Dom7EZhX.js";import{C as he}from"./Card-CU8jzKuK.js";import{S as y}from"./Stack-DSqJGNfN.js";import{T as B}from"./TextField-BfOXJaKd.js";import{I as be}from"./InputAdornment-Cyf39fZQ.js";import{T as ue}from"./TableContainer-D0zNvGRU.js";import{b as Te,c as xe,T as M,a as c}from"./TableHead-D9jAElFw.js";function ve({caseId:n}){const{t}=te("navbar"),[T,U]=o.useState(""),G=[{id:"title",label:t("dashboard.case.notesTab.title")},{id:"description",label:t("dashboard.case.notesTab.description")},{id:"date",label:t("dashboard.case.notesTab.date")},{id:"addedBy",label:t("dashboard.case.notesTab.addedBy")},{id:"actions",label:t("dashboard.case.notesTab.actions")}],[w,L]=o.useState(0),[x,V]=o.useState(5),[X,S]=o.useState(!1),[g,v]=o.useState(""),[m,D]=o.useState(""),[E,h]=o.useState([]),[Y,F]=o.useState(!0),[i,R]=o.useState(!1),[p,A]=o.useState(null),[Z,f]=o.useState(!1),[b,W]=o.useState(null);o.useEffect(()=>{n&&(async()=>{try{F(!0);const s=await re(n);h(Array.isArray(s)?s:[]);try{await N(n,"Tab Viewed","Notes Tab (Backend)")}catch(r){console.error("Failed to log tab view:",r)}}catch(s){console.error("Error fetching notes:",s),l.error(s.message||t("dashboard.case.notesTab.failedToLoad")),h([])}finally{F(!1)}})()},[n,t]);const P=E.filter(a=>a.title.toLowerCase().includes(T.toLowerCase())||a.description.toLowerCase().includes(T.toLowerCase())),J=()=>{A(null),S(!0)},k=()=>{i||(S(!1),v(""),D(""),A(null))},K=async()=>{const a=g.trim(),s=m.trim();if(!a){l.error(t("dashboard.case.notesTab.pleaseEnterNoteTitle"));return}if(!s){l.error(t("dashboard.case.notesTab.pleaseEnterNoteDescription"));return}try{if(R(!0),p){const r=await ne(p.id,a,s);h(d=>d.map(O=>O.id===p.id?r:O));try{await N(n,"Note Updated",`Note: ${a}`)}catch(d){console.error("Failed to log note update:",d)}l.success(t("dashboard.case.notesTab.updatedSuccessfully"))}else{const r=await ie(n,a,s);h(d=>[r,...d]);try{await N(n,"Note Created",`Note: ${a}`)}catch(d){console.error("Failed to log note creation:",d)}l.success(t("dashboard.case.notesTab.addedSuccessfully"))}k()}catch(r){console.error("Submit error:",r),l.error(r.message||t("dashboard.case.notesTab.failedToSave"))}finally{R(!1)}},Q=a=>{W(a),f(!0)},ee=a=>{const s=E.find(r=>r.id===a);s&&(A(s),v(s.title),D(s.description),S(!0))},ae=async()=>{if(b)try{const a=E.find(s=>s.id===b);await le(b),h(s=>s.filter(r=>r.id!==b));try{await N(n,"Note Deleted",a?`Note: ${a.title}`:`Note ID: ${b}`)}catch(s){console.error("Failed to log note delete:",s)}l.success(t("dashboard.case.notesTab.deletedSuccessfully"))}catch(a){l.error(a.message||t("dashboard.case.notesTab.failedToDelete"))}f(!1),W(null)};return Y?e.jsx(I,{sx:{display:"flex",justifyContent:"center",alignItems:"center",minHeight:200},children:e.jsx(se,{})}):e.jsxs(e.Fragment,{children:[e.jsx(he,{children:e.jsxs(I,{sx:{p:3},children:[e.jsxs(y,{direction:"row",alignItems:"center",justifyContent:"space-between",sx:{mb:3},children:[e.jsx(j,{variant:"h6",children:t("dashboard.case.notesTab.heading")}),e.jsxs(y,{direction:"row",spacing:2,children:[e.jsx(B,{value:T,onChange:a=>U(a.target.value),placeholder:t("dashboard.case.notesTab.searchPlaceholder"),InputProps:{startAdornment:e.jsx(be,{position:"start",children:e.jsx(C,{icon:"eva:search-fill"})})},sx:{width:300}}),e.jsx(u,{variant:"contained",startIcon:e.jsx(C,{icon:"solar:add-circle-bold"}),onClick:J,children:t("dashboard.case.notesTab.addNote")})]})]}),e.jsx(ue,{sx:{position:"relative",overflow:"unset"},children:e.jsx(oe,{children:e.jsxs(Te,{children:[e.jsx(de,{headCells:G}),e.jsx(xe,{children:P.length===0?e.jsx(M,{children:e.jsx(c,{colSpan:5,align:"center",children:e.jsx(j,{variant:"body2",color:"text.secondary",children:t(T?"dashboard.case.notesTab.noNotesMatchSearch":"dashboard.case.notesTab.noNotesFound")})})}):P.slice(w*x,w*x+x).map(a=>e.jsxs(M,{hover:!0,children:[e.jsx(c,{children:a.title}),e.jsx(c,{sx:{maxWidth:300},children:e.jsx(j,{variant:"body2",noWrap:!0,children:a.description})}),e.jsx(c,{children:a.created_at?new Date(a.created_at).toLocaleDateString("en-GB",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"}):"N/A"}),e.jsx(c,{children:a.creator?.name||t("dashboard.case.notesTab.unknownUser")}),e.jsx(c,{children:e.jsxs(y,{direction:"row",spacing:1,children:[e.jsx(_,{size:"small",onClick:()=>ee(a.id),children:e.jsx(C,{icon:"solar:pen-bold"})}),e.jsx(_,{size:"small",onClick:()=>Q(a.id),color:"error",children:e.jsx(C,{icon:"solar:trash-bin-trash-bold"})})]})})]},a.id))})]})})}),e.jsx(ce,{page:w,count:P.length,rowsPerPage:x,onPageChange:(a,s)=>L(s),onRowsPerPageChange:a=>{V(parseInt(a.target.value,10)),L(0)}})]})}),e.jsxs($,{open:X,onClose:k,maxWidth:"sm",fullWidth:!0,children:[e.jsx(H,{children:t(p?"dashboard.case.notesTab.editNote":"dashboard.case.notesTab.addNewNote")}),e.jsx(q,{children:e.jsxs(y,{spacing:3,sx:{pt:2},children:[e.jsx(B,{fullWidth:!0,label:t("dashboard.case.notesTab.noteTitle"),value:g,onChange:a=>v(a.target.value),error:!g.trim()&&i,helperText:!g.trim()&&i?t("dashboard.case.notesTab.noteTitleRequired"):""}),e.jsx(B,{fullWidth:!0,label:t("dashboard.case.notesTab.description"),multiline:!0,rows:4,value:m,onChange:a=>D(a.target.value),error:!m.trim()&&i,helperText:!m.trim()&&i?t("dashboard.case.notesTab.descriptionRequired"):""})]})}),e.jsxs(z,{children:[e.jsx(u,{onClick:k,disabled:i,children:t("dashboard.case.notesTab.cancel")}),e.jsx(u,{variant:"contained",onClick:K,disabled:i,children:t(i?"dashboard.case.notesTab.saving":"dashboard.case.notesTab.save")})]})]}),e.jsxs($,{open:Z,onClose:()=>f(!1),children:[e.jsx(H,{children:t("dashboard.case.notesTab.deleteConfirmTitle")}),e.jsx(q,{children:e.jsx(j,{children:t("dashboard.case.notesTab.deleteConfirmMessage")})}),e.jsxs(z,{children:[e.jsx(u,{onClick:()=>f(!1),children:t("dashboard.case.notesTab.cancel")}),e.jsx(u,{variant:"contained",color:"error",onClick:ae,children:t("dashboard.case.notesTab.delete")})]})]})]})}export{ve as N};
