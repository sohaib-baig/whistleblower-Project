import{bf as q,r as o,j as e,B as C,b as K,T as D,I as T,ab as oe,ac as we,ae as O,w as re,c as _,a7 as ee,X as te,Y as ae,Z as se,_ as ne,A as De,cp as ve,cq as Pe,cr as Ne,cs as Ie,ct as ie,a9 as ce,cu as M,O as Ae,J as Le,K as Ee,Q as ke,at as Re}from"./index-BJkBHIXD.js";import{g as Ue}from"./password-session-B6s3sc22.js";import{S as _e,P as Oe,C as Me,b as Fe,c as Be,a as $e}from"./password-guard-DO16_mwR.js";import"./empty-content-Cck_Y1yy.js";import{T as le}from"./table-head-custom-C2dATJUG.js";import{T as de}from"./table-pagination-custom-Dom7EZhX.js";import{S as k}from"./Stack-DSqJGNfN.js";import{T as H}from"./TextField-BfOXJaKd.js";import{I as he}from"./InputAdornment-Cyf39fZQ.js";import{T as ue}from"./TableContainer-D0zNvGRU.js";import{b as pe,c as ge,T as z,a as P}from"./TableHead-D9jAElFw.js";import"./audio-processor-BGEu5NX3.js";import"./Chip-Cd7PxQUv.js";import"./styles-B-zEs6qR.js";import"./format-number-BErDzwe7.js";import"./upload-default-BMHhCMpu.js";import"./index-CDpvdXdB.js";import"./tslib.es6-CTYbIaVE.js";import"./schemas-BaSQ7w8v.js";import"./FormControlLabel-Do9AncA_.js";import"./Select-CM-FquqI.js";import"./LastPage-CrCg5Ljk.js";const He=[{id:"actionPerformed",label:"Action Performed"},{id:"actionValue",label:"Action Value"},{id:"dateTime",label:"Date & Time"}];function We({caseId:l,userId:m,companySlug:N}){const{i18n:t}=q(),[x,h]=o.useState([]),[y,d]=o.useState(!0),[c,S]=o.useState(""),[a,u]=o.useState(0),[b,f]=o.useState(5);o.useEffect(()=>{l&&(async()=>{try{d(!0);const w=await we(l);h(w);try{await O(l,"Tab Viewed","Logs Tab")}catch(v){console.error("Failed to log tab view:",v)}}catch(w){console.error("Error fetching logs:",w),h([])}finally{d(!1)}})()},[l,t.language]);const s=x.filter(i=>(i.action_type||"").toLowerCase().includes(c.toLowerCase())||(i.action_value||"").toLowerCase().includes(c.toLowerCase())),n=(i,w)=>{u(w)},p=i=>{f(parseInt(i.target.value,10)),u(0)};return y?e.jsx(C,{sx:{display:"flex",justifyContent:"center",alignItems:"center",minHeight:200},children:e.jsx(K,{})}):e.jsxs(C,{children:[e.jsxs(k,{direction:"row",alignItems:"center",justifyContent:"space-between",sx:{mb:3},children:[e.jsx(D,{variant:"h6",children:"Action Logs"}),e.jsx(H,{value:c,onChange:i=>S(i.target.value),placeholder:"Search logs...",InputProps:{startAdornment:e.jsx(he,{position:"start",children:e.jsx(T,{icon:"eva:search-fill"})})},sx:{width:300}})]}),e.jsx(ue,{sx:{position:"relative",overflow:"unset"},children:e.jsx(oe,{children:e.jsxs(pe,{children:[e.jsx(le,{headCells:He}),e.jsx(ge,{children:s.length===0?e.jsx(z,{children:e.jsx(P,{colSpan:3,align:"center",children:e.jsx(D,{variant:"body2",color:"text.secondary",children:x.length===0?"No logs found":"No logs match your search"})})}):s.slice(a*b,a*b+b).map(i=>e.jsxs(z,{hover:!0,children:[e.jsx(P,{children:i.action_type}),e.jsx(P,{children:i.action_value||"-"}),e.jsx(P,{children:new Date(i.created_at).toLocaleString("en-US",{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})})]},i.id))})]})})}),e.jsx(de,{page:a,count:s.length,rowsPerPage:b,onPageChange:n,onRowsPerPageChange:p})]})}function Ve({caseId:l,userId:m,companySlug:N}){const{t}=re("navbar"),{i18n:x}=q(),h=[{id:"title",label:t("dashboard.case.notesTab.title","Title")},{id:"description",label:t("dashboard.case.notesTab.description","Description")},{id:"date",label:t("dashboard.case.notesTab.date","Date")},{id:"addedBy",label:t("dashboard.case.notesTab.addedBy","Added By")},{id:"actions",label:t("dashboard.case.notesTab.actions","Actions")}],[y,d]=o.useState(""),[c,S]=o.useState(0),[a,u]=o.useState(5),[b,f]=o.useState(!1),[s,n]=o.useState(""),[p,i]=o.useState(""),[w,v]=o.useState([]),[W,F]=o.useState(!0),[B,Y]=o.useState(!1),[R,V]=o.useState(null),[be,$]=o.useState(!1),[U,G]=o.useState(null),[fe,I]=o.useState(!1),[xe,A]=o.useState(""),[me,L]=o.useState("success");o.useEffect(()=>{l&&(async()=>{try{F(!0);const g=await ve(l);v(g);try{await O(l,"Tab Viewed","Notes Tab")}catch(j){console.error("Failed to log tab view:",j)}}catch(g){console.error("Error fetching notes:",g),A(g.message||"Failed to load notes"),L("error"),I(!0)}finally{F(!1)}})()},[l,x.language]);const J=w.filter(r=>r.title.toLowerCase().includes(y.toLowerCase())||r.description.toLowerCase().includes(y.toLowerCase())),je=()=>{V(null),f(!0)},Q=()=>{B||(f(!1),n(""),i(""),V(null))},ye=async()=>{const r=s.trim(),g=p.trim();if(!r){A(t("dashboard.case.notesTab.pleaseEnterNoteTitle","Please enter a note title")),L("error"),I(!0);return}if(!g){A(t("dashboard.case.notesTab.pleaseEnterNoteDescription","Please enter a note description")),L("error"),I(!0);return}try{if(Y(!0),R){const j=await Pe(R.id,r,g);v(E=>E.map(Z=>Z.id===R.id?j:Z));try{await O(l,"Note Updated",`Note: ${r}`)}catch(E){console.error("Failed to log note update:",E)}A(t("dashboard.case.notesTab.updatedSuccessfully","Note updated successfully"))}else{const j=await Ne(l,m,N,r,g);v(E=>[j,...E]);try{await O(l,"Note Created",`Note: ${r}`)}catch(E){console.error("Failed to log note creation:",E)}A(t("dashboard.case.notesTab.addedSuccessfully","Note added successfully"))}L("success"),I(!0),Q()}catch(j){console.error("Submit error:",j),A(j.message||"Failed to save note"),L("error"),I(!0)}finally{Y(!1)}},Te=r=>{G(r),$(!0)},Ce=r=>{const g=w.find(j=>j.id===r);g&&(V(g),n(g.title),i(g.description),f(!0))},Se=async()=>{if(U)try{const r=w.find(g=>g.id===U);await Ie(U),v(g=>g.filter(j=>j.id!==U));try{await O(l,"Note Deleted",r?`Note: ${r.title}`:`Note ID: ${U}`)}catch(g){console.error("Failed to log note delete:",g)}A(t("dashboard.case.notesTab.deletedSuccessfully","Note deleted successfully")),L("success"),I(!0)}catch(r){A(r.message||t("dashboard.case.notesTab.failedToDelete","Failed to delete note")),L("error"),I(!0)}$(!1),G(null)},X=()=>{I(!1)};return W?e.jsx(C,{sx:{display:"flex",justifyContent:"center",alignItems:"center",minHeight:200},children:e.jsx(K,{})}):e.jsxs(e.Fragment,{children:[e.jsxs(C,{children:[e.jsxs(k,{direction:"row",alignItems:"center",justifyContent:"space-between",sx:{mb:3},children:[e.jsx(D,{variant:"h6",children:t("dashboard.case.notesTab.heading","Notes")}),e.jsxs(k,{direction:"row",spacing:2,children:[e.jsx(H,{value:y,onChange:r=>d(r.target.value),placeholder:t("dashboard.case.notesTab.searchPlaceholder","Search notes..."),InputProps:{startAdornment:e.jsx(he,{position:"start",children:e.jsx(T,{icon:"eva:search-fill"})})},sx:{width:300}}),e.jsx(_,{variant:"contained",startIcon:e.jsx(T,{icon:"solar:add-circle-bold"}),onClick:je,children:t("dashboard.case.notesTab.addNote","Add Note")})]})]}),e.jsx(ue,{sx:{position:"relative",overflow:"unset"},children:e.jsx(oe,{children:e.jsxs(pe,{children:[e.jsx(le,{headCells:h}),e.jsx(ge,{children:J.slice(c*a,c*a+a).map(r=>e.jsxs(z,{hover:!0,children:[e.jsx(P,{children:r.title}),e.jsx(P,{sx:{maxWidth:300},children:e.jsx(D,{variant:"body2",noWrap:!0,children:r.description})}),e.jsx(P,{children:new Date(r.created_at).toLocaleDateString()}),e.jsx(P,{children:r.creator?.name||t("dashboard.case.notesTab.unknownUser","Unknown User")}),e.jsx(P,{children:e.jsxs(k,{direction:"row",spacing:1,children:[e.jsx(ee,{size:"small",onClick:()=>Ce(r.id),children:e.jsx(T,{icon:"solar:pen-bold"})}),e.jsx(ee,{size:"small",onClick:()=>Te(r.id),color:"error",children:e.jsx(T,{icon:"solar:trash-bin-trash-bold"})})]})})]},r.id))})]})})}),e.jsx(de,{page:c,count:J.length,rowsPerPage:a,onPageChange:(r,g)=>S(g),onRowsPerPageChange:r=>{u(parseInt(r.target.value,10)),S(0)}})]}),e.jsxs(te,{open:b,maxWidth:"sm",fullWidth:!0,children:[e.jsx(ae,{children:R?t("dashboard.case.notesTab.editNote","Edit Note"):t("dashboard.case.notesTab.addNewNote","Add New Note")}),e.jsx(se,{children:e.jsxs(k,{spacing:3,sx:{pt:2},children:[e.jsx(H,{fullWidth:!0,label:t("dashboard.case.notesTab.noteTitle","Note Title"),value:s,onChange:r=>n(r.target.value)}),e.jsx(H,{fullWidth:!0,label:t("dashboard.case.notesTab.description","Description"),multiline:!0,rows:4,value:p,onChange:r=>i(r.target.value)})]})}),e.jsxs(ne,{children:[e.jsx(_,{onClick:Q,disabled:B,children:t("dashboard.case.reportSettingTab.cancel","Cancel")}),e.jsx(_,{variant:"contained",onClick:ye,disabled:B,children:B?t("dashboard.case.notesTab.saving","Saving..."):t("dashboard.case.notesTab.save","Save")})]})]}),e.jsxs(te,{open:be,onClose:()=>$(!1),children:[e.jsx(ae,{children:t("dashboard.case.notesTab.deleteConfirmTitle","Delete Note")}),e.jsx(se,{children:e.jsx(D,{children:t("dashboard.case.notesTab.deleteConfirmMessage","Are you sure you want to delete this note? This action cannot be undone.")})}),e.jsxs(ne,{children:[e.jsx(_,{onClick:()=>$(!1),children:t("dashboard.case.reportSettingTab.cancel","Cancel")}),e.jsx(_,{onClick:Se,color:"error",variant:"contained",children:t("dashboard.case.notesTab.delete","Delete")})]})]}),e.jsx(_e,{open:fe,autoHideDuration:6e3,onClose:X,anchorOrigin:{vertical:"bottom",horizontal:"right"},children:e.jsx(De,{onClose:X,severity:me,sx:{width:"100%"},children:xe})})]})}const ze=[{label:"Case Details",icon:e.jsx(T,{width:24,icon:"solar:flag-bold"}),index:0},{label:"Report Setting",icon:e.jsx(T,{width:24,icon:"solar:settings-bold"}),index:1},{label:"Logs",icon:e.jsx(T,{width:24,icon:"solar:bill-list-bold"}),index:2},{label:"Documents",icon:e.jsx(T,{width:24,icon:"solar:file-text-bold"}),index:3},{label:"Notes",icon:e.jsx(T,{width:24,icon:"solar:pen-bold"}),index:4},{label:"Chat",icon:e.jsx(T,{width:24,icon:"solar:chat-round-dots-bold"}),index:5}];function qe({children:l}){const m=ie(),{encryptedCaseId:N}=ce(),[t,x]=o.useState(0),[h,y]=o.useState(0),d=o.useMemo(()=>{if(N)try{const a=M(N);if(a)return a}catch(a){console.error("❌ Failed to decrypt caseId from params:",a)}try{const a=m.pathname,u=a.indexOf("/case-details/");if(u!==-1){const f=a.substring(u+14).split("/").filter(s=>s);if(f.length===1){const s=f[0],n=s.includes("%")?decodeURIComponent(s):s;if(/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(n))return n;try{return M(n)}catch(i){return console.error("❌ Failed to decrypt single ID:",i),n}}if(f.length>=2){const s=f[1]||"";if(s){const n=s.includes("%")?decodeURIComponent(s):s;return M(n)}}}}catch(a){console.error("❌ Failed to extract and decrypt caseId from URL:",a)}return console.warn("⚠️ Could not extract caseId from any source"),""},[N,m.pathname]),c=o.useCallback(async()=>{if(d)try{const a=await Ae(d);x(Math.min(a,99))}catch(a){console.error("❌ Failed to fetch unread chat count:",a),console.error("❌ Error details:",a?.response?.data||a?.message),console.error("❌ Error status:",a?.response?.status),console.error("❌ Error URL:",a?.config?.url),x(0)}},[d]);o.useEffect(()=>{if(!d)return;c();const a=setInterval(()=>{c()},5e3);return()=>{clearInterval(a)}},[d,c]),o.useEffect(()=>{if(!d)return;const a=u=>{u.detail?.caseId===d&&(c(),setTimeout(()=>c(),500),setTimeout(()=>c(),1500))};return window.addEventListener("chatMessagesMarkedAsRead",a),()=>{window.removeEventListener("chatMessagesMarkedAsRead",a)}},[d,c]),o.useEffect(()=>{if(!d)return;const a=m.pathname;if((a.substring(a.indexOf("/case-details/")+14).split("/").filter(n=>n)[2]||"")==="chat"){const n=setTimeout(()=>c(),1e3),p=setTimeout(()=>c(),2e3);return()=>{clearTimeout(n),clearTimeout(p)}}},[m.pathname,d,c]),o.useEffect(()=>{const a=m.pathname,f=a.substring(a.indexOf("/case-details/")+14).split("/").filter(p=>p)[2]||"",n={"":0,"report-setting":1,logs:2,documents:3,notes:4,chat:5}[f]??0;h!==n&&y(n)},[m.pathname,h]);const S=(a,u)=>{const b=m.pathname,f=b.substring(0,b.indexOf("/case-details/")+14),n=b.substring(b.indexOf("/case-details/")+14).split("/").filter(F=>F),p=n[0]||"",i=n[1]||"",v={0:"",1:"report-setting",2:"logs",3:"documents",4:"notes",5:"chat"}[u]||"",W=v?`${f}${p}/${i}/${v}`:`${f}${p}/${i}`;window.location.href=W};return e.jsxs(k,{spacing:3,sx:{pb:{xs:3,md:5},pt:1.5},children:[e.jsx(C,{sx:{borderBottom:1,borderColor:"divider"},children:e.jsx(Le,{value:h,onChange:S,sx:{mb:{xs:3,md:5}},children:ze.map(a=>{const u=a.index===5;return e.jsx(Ee,{label:a.label,value:a.index,icon:u?e.jsx(ke,{badgeContent:t??0,color:"error",sx:{"& .MuiBadge-badge":{fontSize:"0.7rem",minWidth:"18px",height:"18px"}},children:a.icon}):a.icon,iconPosition:"start"},a.index)})})}),e.jsx(C,{sx:{minHeight:"60vh"},children:l})]})}function Ke({caseId:l,userId:m,companySlug:N}){const{t}=re("navbar"),{i18n:x}=q(),[h,y]=o.useState(null),[d,c]=o.useState(!0),[S,a]=o.useState(null);o.useEffect(()=>{l&&(async()=>{try{c(!0),a(null);const n=await Re(l);y(n)}catch(n){console.error("Error fetching case details:",n),a(n.message||"Failed to load report settings")}finally{c(!1)}})()},[l,x.language]);const u=(s,n)=>e.jsxs(C,{sx:{display:"flex",alignItems:"center",gap:2,py:1},children:[e.jsxs(D,{variant:"subtitle2",color:"text.secondary",sx:{minWidth:250},children:[s,":"]}),e.jsx(D,{variant:"body1",sx:{fontWeight:500},children:n||"N/A"})]}),b=s=>{if(!s)return t("dashboard.case.caseDetailsTab.noData","N/A");const n=`dashboard.case.statusOptions.${s.toLowerCase()}`,p=t(n);return p!==n?p:s.charAt(0).toUpperCase()+s.slice(1)},f=s=>{const n=t("dashboard.case.reportSettingTab.yes","Yes"),p=t("dashboard.case.reportSettingTab.no","No");if(s==null)return p;if(typeof s=="boolean"||typeof s=="number")return s?n:p;if(typeof s=="string"){const i=s.toLowerCase();if(i==="1"||i==="true"||i==="yes")return n;if(i==="0"||i==="false"||i==="no")return p}return s.toString()};return d?e.jsx(C,{sx:{display:"flex",justifyContent:"center",alignItems:"center",minHeight:200},children:e.jsx(K,{})}):S?e.jsx(C,{sx:{display:"flex",justifyContent:"center",alignItems:"center",minHeight:200},children:e.jsx(D,{color:"error",children:S})}):h?e.jsxs(C,{children:[e.jsx(D,{variant:"h6",gutterBottom:!0,children:t("dashboard.case.reportSettingTab.heading","Report Details")}),e.jsxs(k,{spacing:3,sx:{mt:3},children:[u(t("dashboard.case.reportSettingTab.assignTo","Assign To"),h?.case_manager_name||t("dashboard.case.caseDetailsTab.noData","N/A")),u(t("dashboard.case.reportSettingTab.assignStatus","Assign Status"),b(h?.status)),u(t("dashboard.case.reportSettingTab.nextOpenStateDeadline","Next Open State Deadline Time"),h?.open_deadline_time||t("dashboard.case.caseDetailsTab.noData","N/A")),u(t("dashboard.case.reportSettingTab.nextCloseStateDeadline","Next Close State Deadline Time"),h?.close_deadline_time||t("dashboard.case.caseDetailsTab.noData","N/A")),u(t("dashboard.case.reportSettingTab.linkWithOtherReport","Link with another report"),h?.other_report_link||t("dashboard.case.caseDetailsTab.noData","N/A")),u(t("dashboard.case.reportSettingTab.autoDeleteAfter30Days","Automatically Delete after 30 days"),f(h?.automatic_delete))]})]}):e.jsx(C,{sx:{display:"flex",justifyContent:"center",alignItems:"center",minHeight:200},children:e.jsx(D,{children:"No report settings available."})})}function ft(){const{slug:l}=ce(),m=ie(),t=m.pathname.substring(m.pathname.indexOf("/case-details/")+14).split("/");let x=t[0]||"",h=t[1]||"";const y=t[2]||"";x.includes("%")&&(x=decodeURIComponent(x)),h.includes("%")&&(h=decodeURIComponent(h));const d=o.useMemo(()=>{try{return x?M(x):""}catch{return""}},[x]),c=o.useMemo(()=>{try{return h?M(h):""}catch{return""}},[h]);if(!x||!h)return e.jsxs("div",{style:{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"100vh",flexDirection:"column",gap:"16px"},children:[e.jsx("h2",{children:"Invalid Case Access"}),e.jsx("p",{children:"The case details URL is invalid or corrupted."})]});const a=Ue(l||"")?.password||"";if(!d||!c)return e.jsxs("div",{style:{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"100vh",flexDirection:"column",gap:"16px"},children:[e.jsx("h2",{children:"Invalid Case Access"}),e.jsx("p",{children:"The case details URL is invalid or corrupted."})]});const u=()=>{},b=()=>{switch(y){case"report-setting":return e.jsx(Ke,{caseId:c,userId:d,companySlug:l||""});case"logs":return e.jsx(We,{caseId:c,userId:d,companySlug:l||""});case"documents":return e.jsx($e,{caseId:c,userId:d,companySlug:l||""});case"notes":return e.jsx(Ve,{caseId:c,userId:d,companySlug:l||""});case"chat":return e.jsx(Fe,{resetChatCount:u,children:e.jsx(Be,{caseId:c,userId:d,companySlug:l||""})});default:return e.jsx(Me,{caseId:c,userId:d,companySlug:l||""})}};return e.jsx(Oe,{companySlug:l||"",requiredPassword:a,children:e.jsx(qe,{children:b()})})}export{ft as default};
