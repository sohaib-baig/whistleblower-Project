import{r,ba as Ie,d5 as _e,a_ as ge,dr as me,d8 as ze,ds as xe,aS as Se,bj as ke,g as De,j as e,k as de,l as Oe,o as Pe,P as Ee,t as Me,da as ye,bT as Ue,b1 as ne,dt as Ne,n as le,w as be,du as $e,x as ce,ae as te,dv as Be,B as w,b as ue,T as E,ag as Te,a7 as ee,I as U,ah as pe,A as Ae,al as je,dw as He,dx as We,dy as Ge,bf as Re,c as ie,ab as Xe,X as Ve,Y as Ke,Z as Je,_ as Ye,dz as Ce,dA as qe,at as Ze,dB as Qe}from"./index-BJkBHIXD.js";import{p as et}from"./audio-processor-BGEu5NX3.js";import{S as O}from"./Stack-DSqJGNfN.js";import{T as fe}from"./TextField-BfOXJaKd.js";import{C as tt}from"./Chip-Cd7PxQUv.js";import"./styles-B-zEs6qR.js";import{U as at}from"./upload-default-BMHhCMpu.js";import"./empty-content-Cck_Y1yy.js";import{T as st}from"./table-head-custom-C2dATJUG.js";import{T as rt}from"./table-pagination-custom-Dom7EZhX.js";import{I as ot}from"./InputAdornment-Cyf39fZQ.js";import{T as nt}from"./TableContainer-D0zNvGRU.js";import{b as it,c as ct,T as we,a as re}from"./TableHead-D9jAElFw.js";import{o as lt,j as dt,s as ut}from"./schemas-BaSQ7w8v.js";import{g as ht,i as mt}from"./password-session-B6s3sc22.js";function ve(a){return a.substring(2).toLowerCase()}function pt(a,n){return n.documentElement.clientWidth<a.clientX||n.documentElement.clientHeight<a.clientY}function gt(a){const{children:n,disableReactTree:T=!1,mouseEvent:t="onClick",onClickAway:f,touchEvent:c="onTouchEnd"}=a,v=r.useRef(!1),j=r.useRef(null),h=r.useRef(!1),y=r.useRef(!1);r.useEffect(()=>(setTimeout(()=>{h.current=!0},0),()=>{h.current=!1}),[]);const S=Ie(_e(n),j),m=ge(x=>{const g=y.current;y.current=!1;const M=me(j.current);if(!h.current||!j.current||"clientX"in x&&pt(x,M))return;if(v.current){v.current=!1;return}let o;x.composedPath?o=x.composedPath().includes(j.current):o=!M.documentElement.contains(x.target)||j.current.contains(x.target),!o&&(T||!g)&&f(x)}),k=x=>g=>{y.current=!0;const M=n.props[x];M&&M(g)},C={ref:S};return c!==!1&&(C[c]=k(c)),r.useEffect(()=>{if(c!==!1){const x=ve(c),g=me(j.current),M=()=>{v.current=!0};return g.addEventListener(x,m),g.addEventListener("touchmove",M),()=>{g.removeEventListener(x,m),g.removeEventListener("touchmove",M)}}},[m,c]),t!==!1&&(C[t]=k(t)),r.useEffect(()=>{if(t!==!1){const x=ve(t),g=me(j.current);return g.addEventListener(x,m),()=>{g.removeEventListener(x,m)}}},[m,t]),r.cloneElement(n,C)}function ft(a={}){const{autoHideDuration:n=null,disableWindowBlurListener:T=!1,onClose:t,open:f,resumeHideDuration:c}=a,v=ze();r.useEffect(()=>{if(!f)return;function o(i){i.defaultPrevented||i.key==="Escape"&&t?.(i,"escapeKeyDown")}return document.addEventListener("keydown",o),()=>{document.removeEventListener("keydown",o)}},[f,t]);const j=ge((o,i)=>{t?.(o,i)}),h=ge(o=>{!t||o==null||v.start(o,()=>{j(null,"timeout")})});r.useEffect(()=>(f&&h(n),v.clear),[f,n,h,v]);const y=o=>{t?.(o,"clickaway")},S=v.clear,m=r.useCallback(()=>{n!=null&&h(c??n*.5)},[n,c,h]),k=o=>i=>{const b=o.onBlur;b?.(i),m()},C=o=>i=>{const b=o.onFocus;b?.(i),S()},x=o=>i=>{const b=o.onMouseEnter;b?.(i),S()},g=o=>i=>{const b=o.onMouseLeave;b?.(i),m()};return r.useEffect(()=>{if(!T&&f)return window.addEventListener("focus",m),window.addEventListener("blur",S),()=>{window.removeEventListener("focus",m),window.removeEventListener("blur",S)}},[T,f,m,S]),{getRootProps:(o={})=>{const i={...xe(a),...xe(o)};return{role:"presentation",...o,...i,onBlur:k(i),onFocus:C(i),onMouseEnter:x(i),onMouseLeave:g(i)}},onClickAway:y}}function bt(a){return Se("MuiSnackbarContent",a)}ke("MuiSnackbarContent",["root","message","action"]);const xt=a=>{const{classes:n}=a;return Pe({root:["root"],action:["action"],message:["message"]},bt,n)},yt=de(Ee,{name:"MuiSnackbarContent",slot:"Root"})(Me(({theme:a})=>{const n=a.palette.mode==="light"?.8:.98;return{...a.typography.body2,color:a.vars?a.vars.palette.SnackbarContent.color:a.palette.getContrastText(ye(a.palette.background.default,n)),backgroundColor:a.vars?a.vars.palette.SnackbarContent.bg:ye(a.palette.background.default,n),display:"flex",alignItems:"center",flexWrap:"wrap",padding:"6px 16px",flexGrow:1,[a.breakpoints.up("sm")]:{flexGrow:"initial",minWidth:288}}})),Tt=de("div",{name:"MuiSnackbarContent",slot:"Message"})({padding:"8px 0"}),jt=de("div",{name:"MuiSnackbarContent",slot:"Action"})({display:"flex",alignItems:"center",marginLeft:"auto",paddingLeft:16,marginRight:-8}),Ct=r.forwardRef(function(n,T){const t=De({props:n,name:"MuiSnackbarContent"}),{action:f,className:c,message:v,role:j="alert",...h}=t,y=t,S=xt(y);return e.jsxs(yt,{role:j,elevation:6,className:Oe(S.root,c),ownerState:y,ref:T,...h,children:[e.jsx(Tt,{className:S.message,ownerState:y,children:v}),f?e.jsx(jt,{className:S.action,ownerState:y,children:f}):null]})});function wt(a){return Se("MuiSnackbar",a)}ke("MuiSnackbar",["root","anchorOriginTopCenter","anchorOriginBottomCenter","anchorOriginTopRight","anchorOriginBottomRight","anchorOriginTopLeft","anchorOriginBottomLeft"]);const vt=a=>{const{classes:n,anchorOrigin:T}=a,t={root:["root",`anchorOrigin${le(T.vertical)}${le(T.horizontal)}`]};return Pe(t,wt,n)},St=de("div",{name:"MuiSnackbar",slot:"Root",overridesResolver:(a,n)=>{const{ownerState:T}=a;return[n.root,n[`anchorOrigin${le(T.anchorOrigin.vertical)}${le(T.anchorOrigin.horizontal)}`]]}})(Me(({theme:a})=>({zIndex:(a.vars||a).zIndex.snackbar,position:"fixed",display:"flex",left:8,right:8,justifyContent:"center",alignItems:"center",variants:[{props:({ownerState:n})=>n.anchorOrigin.vertical==="top",style:{top:8,[a.breakpoints.up("sm")]:{top:24}}},{props:({ownerState:n})=>n.anchorOrigin.vertical!=="top",style:{bottom:8,[a.breakpoints.up("sm")]:{bottom:24}}},{props:({ownerState:n})=>n.anchorOrigin.horizontal==="left",style:{justifyContent:"flex-start",[a.breakpoints.up("sm")]:{left:24,right:"auto"}}},{props:({ownerState:n})=>n.anchorOrigin.horizontal==="right",style:{justifyContent:"flex-end",[a.breakpoints.up("sm")]:{right:24,left:"auto"}}},{props:({ownerState:n})=>n.anchorOrigin.horizontal==="center",style:{[a.breakpoints.up("sm")]:{left:"50%",right:"auto",transform:"translateX(-50%)"}}}]}))),Le=r.forwardRef(function(n,T){const t=De({props:n,name:"MuiSnackbar"}),f=Ue(),c={enter:f.transitions.duration.enteringScreen,exit:f.transitions.duration.leavingScreen},{action:v,anchorOrigin:{vertical:j,horizontal:h}={vertical:"bottom",horizontal:"left"},autoHideDuration:y=null,children:S,className:m,ClickAwayListenerProps:k,ContentProps:C,disableWindowBlurListener:x=!1,message:g,onBlur:M,onClose:o,onFocus:i,onMouseEnter:b,onMouseLeave:K,open:W,resumeHideDuration:se,slots:D={},slotProps:N={},TransitionComponent:A,transitionDuration:$=c,TransitionProps:{onEnter:R,onExited:_,...L}={},...F}=t,B={...t,anchorOrigin:{vertical:j,horizontal:h},autoHideDuration:y,disableWindowBlurListener:x,TransitionComponent:A,transitionDuration:$},ae=vt(B),{getRootProps:J,onClickAway:G}=ft({...B}),[q,Z]=r.useState(!0),Q=u=>{Z(!0),_&&_(u)},p=(u,I)=>{Z(!1),R&&R(u,I)},P={slots:{transition:A,...D},slotProps:{content:C,clickAwayListener:k,transition:L,...N}},[H,X]=ne("root",{ref:T,className:[ae.root,m],elementType:St,getSlotProps:J,externalForwardedProps:{...P,...F},ownerState:B}),[Y,{ownerState:he,...oe}]=ne("clickAwayListener",{elementType:gt,externalForwardedProps:P,getSlotProps:u=>({onClickAway:(...I)=>{const V=I[0];u.onClickAway?.(...I),!V?.defaultMuiPrevented&&G(...I)}}),ownerState:B}),[s,d]=ne("content",{elementType:Ct,shouldForwardComponentProp:!0,externalForwardedProps:P,additionalProps:{message:g,action:v},ownerState:B}),[z,l]=ne("transition",{elementType:Ne,externalForwardedProps:P,getSlotProps:u=>({onEnter:(...I)=>{u.onEnter?.(...I),p(...I)},onExited:(...I)=>{u.onExited?.(...I),Q(...I)}}),additionalProps:{appear:!0,in:W,timeout:$,direction:j==="top"?"down":"up"},ownerState:B});return!W&&q?null:e.jsx(Y,{...oe,...D.clickAwayListener&&{ownerState:he},children:e.jsx(H,{...X,children:e.jsx(z,{...l,children:S||e.jsx(s,{...d})})})})}),Fe=r.createContext(void 0);function Ht({children:a,resetChatCount:n}){return e.jsx(Fe.Provider,{value:{resetChatCount:n},children:a})}function kt(){const a=r.useContext(Fe);if(a===void 0)throw new Error("useChatContext must be used within a ChatProvider");return a}function Wt({caseId:a,userId:n,companySlug:T}){const{t}=be("navbar"),[f,c]=r.useState([]),[v,j]=r.useState(""),[h,y]=r.useState(!1),[S,m]=r.useState(0),[k,C]=r.useState(null),[x,g]=r.useState(null),[M,o]=r.useState(!0),[i,b]=r.useState(!1),[K,W]=r.useState(!1),[se,D]=r.useState(!1),[N,A]=r.useState(""),[$,R]=r.useState("success"),{resetChatCount:_}=kt(),L=r.useRef(null),F=r.useRef([]),B=r.useRef(null),ae=r.useRef(null),J=r.useRef(null),G=r.useCallback(async(s=!1)=>{try{s&&o(!0);const z=(await $e(a)).map(l=>{const u=l.message.startsWith("http")?l.message:`${ce.serverUrl}${l.message}`,I=l.creator?.name||l.sender||t("dashboard.case.chatTab.anonymous","Anonymous");return{id:l.id,message:l.type==="text"?l.message:l.type==="audio"?t("dashboard.case.chatTab.audioMessage","Audio message"):`${t("dashboard.case.chatTab.imageMessage","Image")}: ${l.message.split("/").pop()}`,sender:I,timestamp:new Date(l.timestamp).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),type:l.created_by?"system":"user",messageType:l.type,audioUrl:l.type==="audio"?u:void 0,imageUrl:l.type==="image"?u:void 0,imageName:l.type==="image"?l.message.split("/").pop():void 0}});if(c(z),s){try{await te(a,"Tab Viewed","Chat Tab")}catch(l){console.error("Failed to log tab view:",l)}try{await Be(a),window.dispatchEvent(new CustomEvent("chatMessagesMarkedAsRead",{detail:{caseId:a}})),setTimeout(()=>{window.dispatchEvent(new CustomEvent("chatMessagesMarkedAsRead",{detail:{caseId:a}}))},500)}catch(l){console.error("Failed to mark messages as read:",l)}}}catch(d){console.error("Error fetching chat messages:",d),s&&(A(d.message||t("dashboard.case.chatTab.failedToLoad","Failed to load chat messages")),R("error"),D(!0))}finally{s&&o(!1)}},[a,t]);r.useEffect(()=>{a&&G(!0)},[a,G]),r.useEffect(()=>{if(!a)return;const s=setInterval(()=>{G(!1)},3e3);return()=>clearInterval(s)},[a,G]),r.useEffect(()=>{ae.current?.scrollIntoView({behavior:"smooth"})},[f]);const q=async()=>{const s=v.trim();if(!s){A(t("dashboard.case.chatTab.messageCannotBeEmpty","Message cannot be empty")),R("error"),D(!0);return}if(s.length>1e4){A(t("dashboard.case.chatTab.messageTooLong","Message must not exceed 10,000 characters")),R("error"),D(!0);return}try{b(!0),await He(a,s),j("");try{await te(a,"Chat Message Sent",`Text message: ${s.substring(0,100)}${s.length>100?"...":""}`)}catch(d){console.error("Failed to log chat message:",d)}_(),setTimeout(()=>{G(!1)},1e3)}catch(d){A(d.message||t("dashboard.case.chatTab.failedToSend","Failed to send message")),R("error"),D(!0)}finally{b(!1)}},Z=s=>{s.key==="Enter"&&!s.shiftKey&&(s.preventDefault(),q())},Q=async()=>{try{const s=await navigator.mediaDevices.getUserMedia({audio:!0}),d={},z=["audio/webm","audio/webm;codecs=opus","audio/ogg;codecs=opus","audio/mp4","audio/wav"];for(const u of z)if(MediaRecorder.isTypeSupported(u)){d.mimeType=u;break}const l=new MediaRecorder(s,d);L.current=l,F.current=[],l.ondataavailable=u=>{u.data&&u.data.size>0&&F.current.push(u.data)},l.onerror=u=>{console.error("MediaRecorder error:",u.error),A(t("dashboard.case.chatTab.recordingError","Recording error occurred. Please try again.")),R("error"),D(!0)},l.onstop=async()=>{let u=l.mimeType||"audio/webm";if(u.includes(";")&&(u=u.split(";")[0]),u.startsWith("audio/")||(u="audio/webm"),F.current.length===0){console.error("No audio chunks recorded"),A(t("dashboard.case.chatTab.noAudioData","No audio data recorded. Please try again.")),R("error"),D(!0),s.getTracks().forEach(V=>V.stop());return}const I=new Blob(F.current,{type:u});s.getTracks().forEach(V=>V.stop());try{W(!0);const V=await et(I);P(V)}catch(V){console.error("Error processing audio:",V),P(I)}finally{W(!1)}},l.start(1e3),y(!0),m(0),B.current=setInterval(()=>{m(u=>u+1)},1e3)}catch(s){console.error("Error accessing microphone:",s),A(s.message||t("dashboard.case.chatTab.failedToAccessMicrophone","Failed to access microphone. Please check permissions.")),R("error"),D(!0)}},p=()=>{if(L.current&&h)try{L.current.state==="recording"&&L.current.requestData(),L.current.stop(),y(!1),B.current&&clearInterval(B.current)}catch(s){console.error("Error stopping recording:",s),A(t("dashboard.case.chatTab.errorStoppingRecording","Error stopping recording. Please try again.")),R("error"),D(!0)}},P=async s=>{try{if(b(!0),s.size>10*1024*1024){A(t("dashboard.case.chatTab.audioFileTooLarge","Audio file size must not exceed 10MB")),R("error"),D(!0);return}const d=await Ge(a,s),z=d.message.startsWith("http")?d.message:`${ce.serverUrl}${d.message}`,l={id:d.id,message:`${t("dashboard.case.chatTab.audioMessage","Audio message")} (${Math.round(s.size/1024)}KB)`,sender:t("dashboard.case.chatTab.you","You"),timestamp:new Date(d.timestamp).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),type:"user",messageType:d.type,audioUrl:z};c([...f,l]);try{await te(a,"Chat Message Sent",`Audio message (${Math.round(s.size/1024)}KB)`)}catch(u){console.error("Failed to log audio message:",u)}_()}catch(d){A(d.message||t("dashboard.case.chatTab.failedToSendAudio","Failed to send audio message")),R("error"),D(!0)}finally{b(!1)}},H=s=>{const d=Math.floor(s/60),z=s%60;return`${d}:${z.toString().padStart(2,"0")}`},X=s=>{const d=s.target.files?.[0];if(d&&d.type.startsWith("image/")){C(d);const z=new FileReader;z.onload=l=>{g(l.target?.result)},z.readAsDataURL(d)}},Y=async()=>{if(k)try{if(b(!0),k.size>10*1024*1024){A(t("dashboard.case.chatTab.imageFileTooLarge","Image file size must not exceed 10MB")),R("error"),D(!0);return}if(!["image/jpeg","image/jpg","image/png","image/gif","image/webp"].includes(k.type)){A(t("dashboard.case.chatTab.invalidImageType","Invalid image type. Allowed types: JPEG, JPG, PNG, GIF, WEBP")),R("error"),D(!0);return}const d=await We(a,k),z=d.message.startsWith("http")?d.message:`${ce.serverUrl}${d.message}`,l={id:d.id,message:`${t("dashboard.case.chatTab.imageMessage","Image")}: ${k.name}`,sender:t("dashboard.case.chatTab.you","You"),timestamp:new Date(d.timestamp).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),type:"user",messageType:d.type,imageUrl:z,imageName:k.name};c([...f,l]),C(null),g(null);try{await te(a,"Chat Message Sent",`Image: ${k.name}`)}catch(u){console.error("Failed to log image message:",u)}_()}catch(s){A(s.message||t("dashboard.case.chatTab.failedToSendImage","Failed to send image")),R("error"),D(!0)}finally{b(!1)}},he=s=>e.jsxs(O,{direction:"row",spacing:2,justifyContent:s.type==="user"?"flex-end":"flex-start",sx:{mb:2},children:[s.type!=="user"&&e.jsx(je,{sx:{width:32,height:32},children:e.jsx(U,{icon:"solar:user-id-bold"})}),e.jsx(Ee,{sx:{p:2,maxWidth:"70%",backgroundColor:s.type==="user"?"primary.main":"grey.100",color:s.type==="user"?"primary.contrastText":"text.primary"},children:e.jsxs(O,{spacing:1,children:[e.jsxs(O,{direction:"row",spacing:1,alignItems:"center",justifyContent:"space-between",children:[e.jsx(E,{variant:"caption",sx:{fontWeight:600,opacity:s.type==="user"?.9:.8,fontSize:"0.75rem"},children:s.sender}),e.jsx(tt,{size:"small",label:s.messageType==="audio"?t("dashboard.case.chatTab.voice","Voice"):s.messageType==="image"?t("dashboard.case.chatTab.imageMessage","Image"):t("dashboard.case.chatTab.text","Text"),icon:e.jsx(U,{icon:s.messageType==="audio"?"solar:microphone-bold":s.messageType==="image"?"solar:gallery-add-bold":"solar:chat-round-dots-bold",width:14}),sx:{fontSize:"0.7rem",height:20,backgroundColor:s.type==="user"?"rgba(255,255,255,0.2)":"rgba(0,0,0,0.1)",color:s.type==="user"?"white":"text.secondary"}})]}),s.messageType==="audio"&&s.audioUrl?e.jsxs(w,{children:[e.jsxs("audio",{controls:!0,style:{width:"100%",maxWidth:"300px"},children:[e.jsx("source",{src:s.audioUrl,type:"audio/wav"}),"Your browser does not support the audio element."]}),e.jsx(E,{variant:"caption",sx:{display:"block",mt:.5,opacity:.7},children:s.message})]}):s.messageType==="image"&&s.imageUrl?e.jsxs(w,{children:[e.jsx("img",{src:s.imageUrl,alt:s.imageName||"Uploaded image",style:{maxWidth:"300px",maxHeight:"200px",borderRadius:"8px",objectFit:"cover"}}),e.jsx(E,{variant:"caption",sx:{display:"block",mt:.5,opacity:.7},children:s.message})]}):e.jsx(E,{variant:"body2",sx:{whiteSpace:"pre-wrap"},children:s.message}),e.jsx(E,{variant:"caption",sx:{display:"block",opacity:.7},children:s.timestamp})]})}),s.type==="user"&&e.jsx(je,{sx:{width:32,height:32},children:e.jsx(U,{icon:"solar:user-id-bold"})})]},s.id),oe=()=>{D(!1)};return M?e.jsx(w,{sx:{display:"flex",justifyContent:"center",alignItems:"center",minHeight:200},children:e.jsx(ue,{})}):e.jsxs(w,{sx:{height:"70vh",display:"flex",flexDirection:"column"},children:[e.jsx(w,{sx:{p:2,borderBottom:1,borderColor:"divider"},children:e.jsx(O,{direction:"row",alignItems:"center",justifyContent:"space-between",children:e.jsx(E,{variant:"h6",children:t("dashboard.case.chatTab.heading","Case Chat")})})}),e.jsx(w,{sx:{flex:1,overflow:"auto",p:2},children:f.length===0?e.jsx(w,{sx:{display:"flex",justifyContent:"center",alignItems:"center",minHeight:200},children:e.jsx(E,{variant:"body2",color:"text.secondary",children:t("dashboard.case.chatTab.noMessages","No messages yet. Start a conversation!")})}):e.jsxs(e.Fragment,{children:[f.map(he),e.jsx("div",{ref:ae})]})}),e.jsxs(w,{sx:{p:2,borderTop:1,borderColor:"divider"},children:[h&&e.jsx(w,{sx:{mb:2},children:e.jsxs(O,{direction:"row",spacing:2,alignItems:"center",children:[e.jsxs(w,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(w,{sx:{width:12,height:12,borderRadius:"50%",backgroundColor:"error.main",animation:"pulse 1.5s infinite","@keyframes pulse":{"0%":{opacity:1},"50%":{opacity:.5},"100%":{opacity:1}}}}),e.jsxs(E,{variant:"body2",color:"error.main",children:[t("dashboard.case.chatTab.recording","Recording...")," ",H(S)]})]}),e.jsx(Te,{sx:{flex:1}}),e.jsx(ee,{color:"error",onClick:p,size:"small",children:e.jsx(U,{icon:"solar:copy-bold"})})]})}),K&&e.jsx(w,{sx:{mb:2},children:e.jsxs(O,{direction:"row",spacing:2,alignItems:"center",children:[e.jsx(Te,{sx:{flex:1}}),e.jsx(E,{variant:"body2",color:"text.secondary",children:t("dashboard.case.chatTab.processingAudio")||"Processing audio..."})]})}),e.jsxs(O,{direction:"row",spacing:1,children:[e.jsx(fe,{fullWidth:!0,placeholder:t("dashboard.case.chatTab.typeMessagePlaceholder","Type your message... (Press Enter to send, Shift+Enter for new line)"),value:v,onChange:s=>j(s.target.value),onKeyPress:Z,variant:"outlined",size:"small",multiline:!0,maxRows:3}),e.jsx(pe,{title:t("dashboard.case.chatTab.attachImage","Attach Image"),children:e.jsx(ee,{color:"default",onClick:()=>J.current?.click(),disabled:i,children:e.jsx(U,{icon:"solar:gallery-add-bold"})})}),e.jsx(pe,{title:h?t("dashboard.case.chatTab.stopRecording","Stop Recording"):t("dashboard.case.chatTab.startVoiceRecording","Start Voice Recording"),children:e.jsx(ee,{color:h?"error":"default",onClick:h?p:Q,disabled:i,children:e.jsx(U,{icon:h?"solar:copy-bold":"solar:microphone-bold"})})}),e.jsx(pe,{title:t("dashboard.case.chatTab.send","Send Message"),children:e.jsx(ee,{color:"primary",onClick:q,disabled:!v.trim()||i,children:e.jsx(U,{icon:"custom:send-fill"})})})]}),e.jsx("input",{ref:J,type:"file",accept:"image/*",onChange:X,style:{display:"none"}}),x&&k&&e.jsx(w,{sx:{mt:2,p:2,border:1,borderColor:"divider",borderRadius:1},children:e.jsxs(O,{spacing:2,children:[e.jsx(E,{variant:"subtitle2",children:t("dashboard.case.chatTab.imagePreview","Image Preview")}),e.jsx(w,{component:"img",src:x,alt:"Preview",sx:{maxWidth:"100%",maxHeight:"200px",borderRadius:1,objectFit:"contain"}}),e.jsxs(O,{direction:"row",spacing:1,children:[e.jsx(ee,{size:"small",color:"error",onClick:()=>{C(null),g(null)},children:e.jsx(U,{icon:"solar:trash-bin-trash-bold"})}),e.jsx(ee,{size:"small",color:"primary",onClick:Y,sx:{ml:"auto",bgcolor:"primary.main",color:"primary.contrastText","&:hover":{bgcolor:"primary.dark"}},children:e.jsx(U,{icon:"solar:upload-bold"})})]})]})}),e.jsx(Le,{open:se,autoHideDuration:6e3,onClose:oe,anchorOrigin:{vertical:"bottom",horizontal:"right"},children:e.jsx(Ae,{onClose:oe,severity:$,sx:{width:"100%"},children:N})})]})]})}const Dt=lt({attachment_name:ut().min(1,"Document name is required").max(255,"Document name must not exceed 255 characters"),file:dt(File).refine(a=>a.size<=10*1024*1024,"File size must not exceed 10MB").refine(a=>{const n=["pdf","doc","docx","xls","xlsx","ppt","pptx","txt","jpg","jpeg","png","gif"],T=a.name.split(".").pop()?.toLowerCase();return T&&n.includes(T)},"Invalid file type. Allowed types: PDF, DOC, DOCX, XLS, XLSX, PPT, PPTX, TXT, JPG, JPEG, PNG, GIF")});function Gt({caseId:a,userId:n,companySlug:T}){const{t}=be("navbar"),{i18n:f}=Re(),[c,v]=r.useState(""),[j,h]=r.useState(0),[y,S]=r.useState(5),[m,k]=r.useState(!1),[C,x]=r.useState(""),[g,M]=r.useState(null),[o,i]=r.useState([]),[b,K]=r.useState(!0),[W,se]=r.useState(!1),[D,N]=r.useState(!1),[A,$]=r.useState(""),[R,_]=r.useState("success"),[L,F]=r.useState({}),B=[{id:"title",label:t("dashboard.case.documentsTab.title","Title")},{id:"document",label:t("dashboard.case.documentsTab.document","Document")},{id:"uploadedAt",label:t("dashboard.case.documentsTab.uploadedAt","Uploaded At")},{id:"actions",label:t("dashboard.case.documentsTab.actions","Actions")}];r.useEffect(()=>{a&&(async()=>{try{K(!0);const P=await Ce(a);i(P);try{await te(a,"Tab Viewed","Documents Tab")}catch(H){console.error("Failed to log tab view:",H)}}catch(P){console.error("Error fetching attachments:",P),$(P.message||"Failed to load documents"),_("error"),N(!0)}finally{K(!1)}})()},[a,f.language]);const ae=()=>{k(!0)},J=()=>{k(!1),x(""),M(null),F({})},G=async()=>{if(F({}),!C.trim()){F({attachment_name:"Document name is required"}),$("Please enter a document name"),_("error"),N(!0);return}if(!g){F({file:"File is required"}),$("Please select a file to upload"),_("error"),N(!0);return}if(g.size>10*1024*1024){F({file:"File size must not exceed 10MB"}),$("File size must not exceed 10MB"),_("error"),N(!0);return}const p=["pdf","doc","docx","xls","xlsx","ppt","pptx","txt","jpg","jpeg","png","gif"],P=g.name.split(".").pop()?.toLowerCase();if(!P||!p.includes(P)){F({file:"Invalid file type. Allowed types: PDF, DOC, DOCX, XLS, XLSX, PPT, PPTX, TXT, JPG, JPEG, PNG, GIF"}),$("Invalid file type"),_("error"),N(!0);return}try{Dt.parse({attachment_name:C,file:g}),se(!0),await qe(a,g,C);try{await te(a,"Document Uploaded",`Document: ${C} (${g.name})`)}catch(X){console.error("Failed to log document upload:",X)}const H=await Ce(a);i(H),$("Document uploaded successfully"),_("success"),N(!0),J()}catch(H){if(H.errors){const X={};H.errors.forEach(Y=>{Y.path[0]==="attachment_name"?X.attachment_name=Y.message:Y.path[0]==="file"&&(X.file=Y.message)}),F(X)}$(H.message||"Failed to upload document"),_("error"),N(!0)}finally{se(!1)}},q=p=>{const P=p.attachment_path.startsWith("http")?p.attachment_path:`${ce.serverUrl}${p.attachment_path}`;window.open(P,"_blank")},Z=()=>{N(!1)};if(b)return e.jsx(w,{sx:{display:"flex",justifyContent:"center",alignItems:"center",minHeight:200},children:e.jsx(ue,{})});const Q=o.filter(p=>p.attachment_name.toLowerCase().includes(c.toLowerCase()));return e.jsxs(e.Fragment,{children:[e.jsxs(w,{children:[e.jsxs(O,{direction:"row",alignItems:"center",justifyContent:"space-between",sx:{mb:3},children:[e.jsx(E,{variant:"h6",children:t("dashboard.case.documentsTab.heading","Documents")}),e.jsxs(O,{direction:"row",spacing:2,children:[e.jsx(fe,{value:c,onChange:p=>v(p.target.value),placeholder:t("dashboard.case.documentsTab.searchPlaceholder","Search documents..."),InputProps:{startAdornment:e.jsx(ot,{position:"start",children:e.jsx(U,{icon:"eva:search-fill"})})},sx:{width:300}}),e.jsx(ie,{variant:"contained",startIcon:e.jsx(U,{icon:"solar:add-circle-bold"}),onClick:ae,children:t("dashboard.case.documentsTab.newDocument","New Document")})]})]}),e.jsx(nt,{sx:{position:"relative",overflow:"unset"},children:e.jsx(Xe,{children:e.jsxs(it,{children:[e.jsx(st,{headCells:B}),e.jsx(ct,{children:Q.length===0?e.jsx(we,{children:e.jsx(re,{colSpan:4,align:"center",children:e.jsx(E,{variant:"body2",color:"text.secondary",sx:{py:3},children:t("dashboard.case.documentsTab.noDocumentsFound","No documents found")})})}):Q.slice(j*y,j*y+y).map(p=>e.jsxs(we,{hover:!0,children:[e.jsx(re,{children:p.attachment_name}),e.jsx(re,{children:e.jsxs(ie,{variant:"text",startIcon:e.jsx(U,{icon:"solar:download-bold"}),onClick:()=>q(p),children:[p.attachment_name,".",p.attachment_type]})}),e.jsx(re,{children:p.created_at}),e.jsx(re,{children:e.jsx(O,{direction:"row",spacing:1,children:e.jsx(ee,{size:"small",onClick:()=>q(p),children:e.jsx(U,{icon:"solar:download-bold"})})})})]},p.id))})]})})}),e.jsx(rt,{page:j,count:Q.length,rowsPerPage:y,onPageChange:(p,P)=>h(P),onRowsPerPageChange:p=>{S(parseInt(p.target.value,10)),h(0)}})]}),e.jsxs(Ve,{open:m,onClose:J,maxWidth:"sm",fullWidth:!0,children:[e.jsx(Ke,{children:t("dashboard.case.documentsTab.uploadNewDocument","Upload New Document")}),e.jsx(Je,{children:e.jsxs(O,{spacing:3,sx:{pt:2},children:[e.jsx(fe,{fullWidth:!0,label:t("dashboard.case.documentsTab.documentTitle","Document Name"),value:C,onChange:p=>{x(p.target.value),L.attachment_name&&F({...L,attachment_name:void 0})},error:!!L.attachment_name,helperText:L.attachment_name,required:!0}),e.jsxs(w,{children:[e.jsx(at,{value:g,onDrop:p=>{M(p[0]),L.file&&F({...L,file:void 0})},onDelete:()=>{M(null),L.file&&F({...L,file:void 0})}}),L.file&&e.jsx(E,{variant:"caption",color:"error",sx:{mt:1,display:"block"},children:L.file})]})]})}),e.jsxs(Ye,{children:[e.jsx(ie,{onClick:J,disabled:W,children:t("dashboard.case.reportSettingTab.cancel","Cancel")}),e.jsx(ie,{variant:"contained",onClick:G,disabled:W,children:W?t("dashboard.case.documentsTab.uploading","Uploading..."):t("dashboard.case.documentsTab.upload","Upload")})]})]}),e.jsx(Le,{open:D,autoHideDuration:6e3,onClose:Z,anchorOrigin:{vertical:"bottom",horizontal:"right"},children:e.jsx(Ae,{onClose:Z,severity:R,sx:{width:"100%"},children:A})})]})}function Xt({caseId:a,userId:n,companySlug:T}){const{t}=be("navbar"),{i18n:f}=Re(),[c,v]=r.useState(null),[j,h]=r.useState(!0),[y,S]=r.useState(null);r.useEffect(()=>{a&&(async()=>{try{h(!0),S(null);const i=await Ze(a);v(i);try{await te(a,"Tab Viewed","Case Details Tab")}catch(b){console.error("Failed to log tab view:",b)}}catch(i){console.error("Error fetching case details:",i),S(i.message||"Failed to load case details")}finally{h(!1)}})()},[a,f.language]);const m=(o,i)=>e.jsxs(w,{sx:{display:"flex",alignItems:"center",gap:2,py:1},children:[e.jsxs(E,{variant:"subtitle2",color:"text.secondary",sx:{minWidth:180},children:[o,":"]}),e.jsx(E,{variant:"body1",children:i})]});if(j)return e.jsx(w,{sx:{display:"flex",justifyContent:"center",alignItems:"center",minHeight:200},children:e.jsx(ue,{})});if(y)return e.jsx(w,{sx:{display:"flex",justifyContent:"center",alignItems:"center",minHeight:200},children:e.jsx(E,{color:"error",children:y||t("dashboard.case.caseDetailsTab.failedToLoad","Failed to load case details")})});if(!c)return e.jsx(w,{sx:{display:"flex",justifyContent:"center",alignItems:"center",minHeight:200},children:e.jsx(E,{children:t("dashboard.case.caseDetailsTab.failedToLoad","No case data available.")})});const k=Array.isArray(c.hidden_fields)?c.hidden_fields:[],C=o=>!k.includes(o),x=o=>{if(!o)return t("dashboard.case.caseDetailsTab.noData","N/A");const i=`dashboard.case.caseDetailsTab.${o.toLowerCase()}`,b=t(i);return b!==i?b:o.split("_").map(K=>K.charAt(0).toUpperCase()+K.slice(1)).join(" ")},g=o=>{if(!o)return t("dashboard.case.caseDetailsTab.noData","N/A");const i={report_annonymously:t("dashboard.case.caseDetailsTab.reportAnnonymously","Report Annonymously"),report_with_personal_details:t("dashboard.case.caseDetailsTab.reportWithPersonalDetails","Report with Personal Details")};return i[o]?i[o]:o.split("_").map(b=>b.charAt(0).toUpperCase()+b.slice(1)).join(" ")},M=o=>{if(!o)return t("dashboard.case.caseDetailsTab.noData","N/A");const i=`dashboard.case.statusOptions.${o.toLowerCase()}`,b=t(i);return b!==i?b:o.charAt(0).toUpperCase()+o.slice(1)};return e.jsxs(w,{children:[e.jsx(E,{variant:"h6",gutterBottom:!0,children:t("dashboard.case.caseDetails","Case Information")}),e.jsxs(O,{spacing:3,children:[m(t("dashboard.case.tableHeaders.caseId","Case ID"),c?.case_id||c?.id||a),C("dateTime")&&m(t("dashboard.case.caseDetailsTab.dateTime","Date & Time"),c?.date_time||c?.created_at||t("dashboard.case.caseDetailsTab.noData","N/A")),C("subject")&&m(t("dashboard.case.caseDetailsTab.subject","Subject"),c?.subject||c?.title||t("dashboard.case.caseDetailsTab.noData","N/A")),C("description")&&m(t("dashboard.case.caseDetailsTab.description","Description"),c?.description||t("dashboard.case.caseDetailsTab.noData","N/A")),C("category")&&m(t("dashboard.case.caseDetailsTab.category","Category"),c?.category||t("dashboard.case.caseDetailsTab.noData","N/A")),C("reportingMedium")&&m(t("dashboard.case.caseDetailsTab.reportingMedium","Reporting Medium"),x(c?.reporting_medium||"")),m(t("dashboard.case.caseDetailsTab.reportType","Report Type"),g(c?.report_type||"")),m(t("dashboard.case.tableHeaders.status","Status"),M(c?.status||"")),c?.case_manager_name&&C("assignedTo")&&m(t("dashboard.case.caseDetailsTab.assignedTo","Case Manager"),c.case_manager_name),c?.email&&m(t("dashboard.case.caseManagers.tableHeaders.email","Email"),c.email)]})]})}function Vt({children:a,companySlug:n,requiredPassword:T}){const[t,f]=r.useState(!1),[c,v]=r.useState(!0);return r.useEffect(()=>{(()=>{try{const h=ht(n),y=mt(n);if(T&&h){const S=h.password===T;f(y&&S)}else f(y)}catch(h){console.error("Password guard authentication error:",h),f(!1)}finally{v(!1)}})()},[n,T]),c?e.jsxs(w,{sx:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",minHeight:"100vh",gap:2},children:[e.jsx(ue,{size:40}),e.jsx(E,{variant:"body2",color:"text.secondary",children:"Verifying access..."})]}):t?e.jsx(e.Fragment,{children:a}):e.jsx(Qe,{to:`/company/${n}/login`,replace:!0})}export{Xt as C,Vt as P,Le as S,Gt as a,Ht as b,Wt as c};
