async function h(n){try{const s=new(window.AudioContext||window.webkitAudioContext),r=await n.arrayBuffer(),l=await s.decodeAudioData(r),o=new OfflineAudioContext(l.numberOfChannels,l.length,l.sampleRate),c=o.createBufferSource();c.buffer=l;const p=o.createGain(),i=o.createBiquadFilter();i.type="lowpass",i.frequency.value=4e3,i.Q.value=1;const u=o.createDelay(.1);u.delayTime.value=.02;const e=o.createGain();e.gain.value=.1;const a=o.createDynamicsCompressor();a.threshold.value=-24,a.knee.value=30,a.ratio.value=12,a.attack.value=.003,a.release.value=.25,c.connect(i),i.connect(u),u.connect(e),e.connect(a),i.connect(a),a.connect(p),p.connect(o.destination);const w=.98+(Math.random()*.04-.02);c.playbackRate.value=w,p.gain.value=.95,c.start(0);const t=await o.startRendering(),d=await y(t,n.type);return s.close(),d}catch(s){return console.error("Error processing audio for anonymity:",s),n}}async function y(n,s){const r=s.includes("wav"),l=s.includes("mp4");return r||l?m(n):b(n)}function m(n){const s=n.numberOfChannels,r=n.length,l=n.sampleRate,c=s*2,p=l*c,i=r*c,u=new ArrayBuffer(44+i),e=new DataView(u),a=(t,d)=>{for(let f=0;f<d.length;f++)e.setUint8(t+f,d.charCodeAt(f))};a(0,"RIFF"),e.setUint32(4,36+i,!0),a(8,"WAVE"),a(12,"fmt "),e.setUint32(16,16,!0),e.setUint16(20,1,!0),e.setUint16(22,s,!0),e.setUint32(24,l,!0),e.setUint32(28,p,!0),e.setUint16(32,c,!0),e.setUint16(34,16,!0),a(36,"data"),e.setUint32(40,i,!0);let w=44;for(let t=0;t<r;t++)for(let d=0;d<s;d++){const f=Math.max(-1,Math.min(1,n.getChannelData(d)[t]));e.setInt16(w,f<0?f*32768:f*32767,!0),w+=2}return new Blob([u],{type:"audio/wav"})}async function b(n,s){return new Promise((r,l)=>{try{const o=new(window.AudioContext||window.webkitAudioContext),c=o.createBufferSource();c.buffer=n;const p=o.createMediaStreamDestination();c.connect(p);const i=["audio/webm","audio/webm;codecs=opus","audio/ogg;codecs=opus"];let u="audio/webm";for(const t of i)if(MediaRecorder.isTypeSupported(t)){u=t;break}const e=new MediaRecorder(p.stream,{mimeType:u}),a=[];e.ondataavailable=t=>{t.data&&t.data.size>0&&a.push(t.data)},e.start(100),c.start(0);const w=setTimeout(()=>{try{c.stop(),e.state==="recording"&&(e.requestData(),e.stop())}catch{if(a.length>0){const t=new Blob(a,{type:u});o.close(),r(t)}else{const t=m(n);o.close(),r(t)}}},n.duration*1e3+200);e.onstop=()=>{clearTimeout(w);const t=new Blob(a,{type:u});o.close(),r(t)},e.onerror=t=>{clearTimeout(w),o.close();const d=m(n);r(d)}}catch{const o=m(n);r(o)}})}export{h as p};
