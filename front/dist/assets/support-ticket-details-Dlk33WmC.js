import{a9 as S,r as p,a0 as x,j as e,bx as $,T as s,B as c,bP as f,c as u,a6 as L,ab as P,al as T,bQ as C,bS as A,bT as U,a7 as Y,I as G,W as M,aa as N}from"./index-BJkBHIXD.js";import"./empty-content-Cck_Y1yy.js";import"./text-transform-DM798QSo.js";import"./styles-B-zEs6qR.js";import{a as W}from"./index.esm-DG78EUPk.js";import{a as H,b as J,d as O,m as Q,u as q}from"./support-ticket-BcjHfbJs.js";import{F as K}from"./fields-wQ2IQIfM.js";import{F as X}from"./form-provider-BYLnCB41.js";import{C as j}from"./Card-CU8jzKuK.js";import{G as y}from"./Grid-D_Et280v.js";import{S as n}from"./Stack-DSqJGNfN.js";import"./TextField-BfOXJaKd.js";import"./Select-CM-FquqI.js";import"./format-number-BErDzwe7.js";import"./index-BdCJuPE0.js";import"./rhf-phone-input-DvY4aKGv.js";import"./index-CDpvdXdB.js";import"./search-not-found-BYtFGFNz.js";import"./InputAdornment-Cyf39fZQ.js";import"./rhf-text-field-D45rQogC.js";import"./RadioGroup-eX8WPtuC.js";import"./FormControlLabel-Do9AncA_.js";import"./Autocomplete-vOabT0lM.js";import"./Chip-Cd7PxQUv.js";import"./rhf-select-BCHEEYe2.js";import"./upload-default-BMHhCMpu.js";import"./tslib.es6-CTYbIaVE.js";import"./DatePicker-D3hVcc_W.js";function Z(){const{id:r}=S(),[t,d]=p.useState(null),[o,h]=p.useState([]),[_,b]=p.useState(!0),[R,g]=p.useState(!1),k=p.useRef(null),v=W({defaultValues:{support_ticket_id:r||"",content:""}}),{handleSubmit:D,reset:I,watch:F,setValue:E}=v,z=F("content");p.useEffect(()=>{(async()=>{if(r)try{b(!0);const a=await J(r);if(d(a),a&&Array.isArray(a.chats))h(a.chats);else try{const l=await O(r),m=Array.isArray(l.data)?l.data:[];h(m)}catch{h([])}await Q(r)}catch(a){x.error(a.response?.data?.message||"Failed to load support ticket")}finally{b(!1)}})()},[r]),p.useEffect(()=>{k.current?.scrollIntoView({behavior:"smooth"})},[o]);const B=D(async i=>{if(t)try{g(!0);const a={...i,support_ticket_id:t.id},l=await H(a),m={...l,sender:l.sender||{id:l.reply_from,name:"You"},receiver:l.receiver||void 0};h(V=>[...V,m]),I({support_ticket_id:t.id,content:""}),E("content",""),x.success("Reply sent successfully!")}catch(a){x.error(a.message||"Failed to send reply")}finally{g(!1)}}),w=async i=>{if(t)try{await q(t.id,i),d(a=>a?{...a,status:i}:null),x.success(`Ticket ${i==="closed"?"closed":"reopened"} successfully!`)}catch{x.error("Failed to update ticket status")}};return _?e.jsx($,{}):!t||!t.id?e.jsxs(j,{sx:{p:3},children:[e.jsx(s,{variant:"h6",children:"Support ticket not found"}),e.jsxs(s,{variant:"body2",color:"text.secondary",sx:{mt:1},children:["Ticket data: ",JSON.stringify(t)]})]}):e.jsxs(y,{container:!0,spacing:3,children:[e.jsx(y,{size:{xs:12,md:8},children:e.jsxs(j,{sx:{p:3},children:[e.jsxs(n,{direction:"row",alignItems:"center",justifyContent:"space-between",sx:{mb:3},children:[e.jsxs(c,{children:[e.jsx(s,{variant:"h6",sx:{mb:1},children:t.title}),e.jsxs(n,{direction:"row",alignItems:"center",spacing:2,children:[e.jsxs(s,{variant:"body2",color:"text.secondary",children:["Ticket #",t.id.slice(-8)]}),e.jsx(f,{variant:"soft",color:t.status==="open"?"success":"default",children:t.status})]})]}),e.jsxs(n,{direction:"row",spacing:1,children:[t.status==="open"&&e.jsx(u,{variant:"outlined",color:"error",size:"small",onClick:()=>w("closed"),children:"Close Ticket"}),t.status==="closed"&&e.jsx(u,{variant:"outlined",color:"success",size:"small",onClick:()=>w("open"),children:"Reopen Ticket"})]})]}),e.jsx(L,{sx:{mb:3}}),e.jsxs(c,{sx:{mb:3},children:[e.jsx(s,{variant:"subtitle1",sx:{mb:2},children:"Conversation"}),e.jsx(P,{sx:{maxHeight:400,p:2,bgcolor:"grey.50",borderRadius:1},children:e.jsxs(n,{spacing:3,children:[Array.isArray(o)?o.length>0?o.filter(i=>i&&i.id).map(i=>e.jsx(ee,{chat:i},i.id)):e.jsx(s,{variant:"body2",color:"text.secondary",sx:{textAlign:"center",py:2},children:"No messages yet. Start a conversation!"}):e.jsx(s,{variant:"body2",color:"text.secondary",sx:{textAlign:"center",py:2},children:"Loading conversation..."}),e.jsx("div",{ref:k})]})})]}),t.status==="open"&&e.jsx(X,{methods:v,onSubmit:B,children:e.jsxs(n,{spacing:2,children:[e.jsx(K.Text,{name:"content",label:"Your Reply",multiline:!0,rows:3,placeholder:"Type your reply here..."}),e.jsxs(n,{direction:"row",spacing:2,justifyContent:"space-between",alignItems:"center",children:[e.jsx(s,{variant:"caption",color:"text.secondary",children:"Press Enter to send, Shift+Enter for new line"}),e.jsx(u,{type:"submit",variant:"contained",loading:R,disabled:!z?.trim(),children:"Send Reply"})]})]})}),t.status==="closed"&&e.jsx(c,{sx:{p:2,bgcolor:"warning.lighter",borderRadius:1},children:e.jsx(s,{variant:"body2",color:"warning.darker",children:"This ticket is closed. You cannot send new replies."})})]})}),e.jsx(y,{size:{xs:12,md:4},children:e.jsxs(j,{sx:{p:3},children:[e.jsx(s,{variant:"subtitle1",sx:{mb:2},children:"Ticket Information"}),e.jsxs(n,{spacing:2,children:[e.jsxs(c,{children:[e.jsx(s,{variant:"body2",color:"text.secondary",children:"Created By"}),e.jsxs(n,{direction:"row",alignItems:"center",spacing:1,sx:{mt:.5},children:[e.jsx(T,{sx:{width:24,height:24},children:t.creator.name.charAt(0).toUpperCase()}),e.jsx(s,{variant:"body2",children:t.creator.name})]})]}),e.jsxs(c,{children:[e.jsx(s,{variant:"body2",color:"text.secondary",children:"Created Date"}),e.jsxs(s,{variant:"body2",sx:{mt:.5},children:[C(t.created_at)," at ",A(t.created_at)]})]}),e.jsxs(c,{children:[e.jsx(s,{variant:"body2",color:"text.secondary",children:"Status"}),e.jsx(f,{variant:"soft",color:t.status==="open"?"success":"default",sx:{mt:.5},children:t.status})]}),e.jsxs(c,{children:[e.jsx(s,{variant:"body2",color:"text.secondary",children:"Total Messages"}),e.jsx(s,{variant:"body2",sx:{mt:.5},children:o.length})]})]})]})})]})}function ee({chat:r}){const t=U(),d=r.created_from==="admin",o=r.sender||{id:r.reply_from,name:"Unknown"};return e.jsxs(n,{direction:"row",spacing:2,sx:{flexDirection:d?"row":"row-reverse"},children:[e.jsx(T,{sx:{width:32,height:32},children:o.name?o.name.charAt(0).toUpperCase():"?"}),e.jsxs(c,{sx:{maxWidth:"70%",p:2,borderRadius:2,bgcolor:d?t.palette.primary.lighter:t.palette.grey[100],border:`1px solid ${d?t.palette.primary.light:t.palette.grey[300]}`},children:[e.jsxs(n,{direction:"row",alignItems:"center",spacing:1,sx:{mb:1},children:[e.jsx(s,{variant:"subtitle2",children:o.name||"Unknown"}),e.jsx(f,{variant:"soft",color:d?"primary":"default",sx:{fontSize:"0.75rem",height:20},children:r.created_from})]}),e.jsx(s,{variant:"body2",sx:{whiteSpace:"pre-wrap"},children:r.content}),r.attachment&&e.jsxs(c,{sx:{mt:1},children:[e.jsx(Y,{size:"small",children:e.jsx(G,{icon:"eva:download-fill"})}),e.jsx(s,{variant:"caption",color:"text.secondary",children:"Attachment"})]}),e.jsxs(s,{variant:"caption",color:"text.secondary",sx:{mt:1,display:"block"},children:[C(r.created_at)," at ",A(r.created_at)]})]})]})}function te(){const{id:r}=S();return e.jsxs(M,{children:[e.jsx(N,{heading:`Support Ticket #${r?.slice(-8)}`,links:[{name:"Dashboard",href:"/dashboard"},{name:"Support Tickets",href:"/dashboard/support-tickets"},{name:`Ticket #${r?.slice(-8)}`}],sx:{mb:{xs:3,md:5}}}),e.jsx(Z,{})]})}function De(){return e.jsx(te,{})}export{De as default};
