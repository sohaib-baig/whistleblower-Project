import{w as X,r as i,ad as Z,ae as T,af as ee,j as e,B as d,T as l,ag as N,a7 as v,I as u,c as K,ah as S,ai as se,aj as ae,ak as re,al as L,P as te}from"./index-BJkBHIXD.js";import{p as oe}from"./audio-processor-BGEu5NX3.js";import{C as ie}from"./Card-CU8jzKuK.js";import{S as g}from"./Stack-DSqJGNfN.js";import{T as ne}from"./TextField-BfOXJaKd.js";import{C as ce}from"./Chip-Cd7PxQUv.js";function ue({caseId:n}){const{t:o}=X("navbar"),[y,b]=i.useState([]),[C,E]=i.useState(""),[x,A]=i.useState(!1),[H,$]=i.useState(0),[m,M]=i.useState(null),[z,R]=i.useState(null),[O,U]=i.useState(!0),[V,P]=i.useState(!1),f=i.useRef(null),j=i.useRef([]),k=i.useRef(null),F=i.useRef(null),W=i.useRef(null),w=i.useCallback(async(s=!1)=>{try{s&&U(!0);const c=(await Z(n)).map(r=>{const t=r.message.startsWith("http")?r.message:`https://portal.wisling.com${r.message}`,h=r.creator?.name||r.sender||o("dashboard.case.chatTab.anonymous","Anonymous");return{id:r.id,message:r.type==="text"?r.message:r.type==="audio"?o("dashboard.case.chatTab.audioMessage"):`${o("dashboard.case.chatTab.imageMessage")}: ${r.message.split("/").pop()}`,sender:h,timestamp:new Date(r.timestamp).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),type:r.created_by?"user":"system",messageType:r.type,audioUrl:r.type==="audio"?t:void 0,imageUrl:r.type==="image"?t:void 0,imageName:r.type==="image"?r.message.split("/").pop():void 0}});if(b(c),s){try{await T(n,"Tab Viewed","Chat Tab (Backend)")}catch(r){console.error("Failed to log tab view:",r)}try{await ee(n),window.dispatchEvent(new CustomEvent("chatMessagesMarkedAsRead",{detail:{caseId:n}})),setTimeout(()=>{window.dispatchEvent(new CustomEvent("chatMessagesMarkedAsRead",{detail:{caseId:n}}))},500)}catch(r){console.error("Failed to mark messages as read:",r)}}}catch(a){console.error("Error fetching chat messages:",a),s&&b([])}finally{s&&U(!1)}},[n,o]);i.useEffect(()=>{n&&w(!0)},[n,w]),i.useEffect(()=>{if(!n)return;const s=setInterval(()=>{w(!1)},3e3);return()=>clearInterval(s)},[n,w]),i.useEffect(()=>{F.current?.scrollIntoView({behavior:"smooth"})},[y]);const B=async()=>{const s=C.trim();if(s&&!(s.length>1e4))try{const a=await se(n,s),c=a.creator?.name||a.sender||o("dashboard.case.chatTab.anonymous","Anonymous"),r={id:a.id,message:a.message,sender:c,timestamp:new Date(a.timestamp).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),type:"user",messageType:a.type};b([...y,r]),E("");try{await T(n,"Chat Message Sent",`Text message: ${s.substring(0,100)}${s.length>100?"...":""}`)}catch(t){console.error("Failed to log chat message:",t)}}catch(a){console.error("Error sending message:",a)}},q=s=>{s.key==="Enter"&&!s.shiftKey&&(s.preventDefault(),B())},Y=async()=>{try{const s=await navigator.mediaDevices.getUserMedia({audio:!0}),a={},c=["audio/webm","audio/webm;codecs=opus","audio/ogg;codecs=opus","audio/mp4","audio/wav"];for(const t of c)if(MediaRecorder.isTypeSupported(t)){a.mimeType=t;break}const r=new MediaRecorder(s,a);f.current=r,j.current=[],r.ondataavailable=t=>{t.data&&t.data.size>0&&j.current.push(t.data)},r.onerror=t=>{console.error("MediaRecorder error:",t.error)},r.onstop=async()=>{let t=r.mimeType||"audio/webm";if(t.includes(";")&&(t=t.split(";")[0]),t.startsWith("audio/")||(t="audio/webm"),j.current.length===0){console.error("No audio chunks recorded"),s.getTracks().forEach(p=>p.stop());return}const h=new Blob(j.current,{type:t});s.getTracks().forEach(p=>p.stop());try{P(!0);const p=await oe(h);I(p)}catch(p){console.error("Error processing audio:",p),I(h)}finally{P(!1)}},r.start(1e3),A(!0),$(0),k.current=setInterval(()=>{$(t=>t+1)},1e3)}catch(s){console.error("Error accessing microphone:",s)}},D=()=>{if(f.current&&x)try{f.current.state==="recording"&&f.current.requestData(),f.current.stop(),A(!1),k.current&&clearInterval(k.current)}catch(s){console.error("Error stopping recording:",s)}},I=async s=>{try{if(s.size>10*1024*1024)return;const a=await ae(n,s),c=a.message.startsWith("http")?a.message:`https://portal.wisling.com${a.message}`,r=a.creator?.name||a.sender||o("dashboard.case.chatTab.anonymous","Anonymous"),t={id:a.id,message:`${o("dashboard.case.chatTab.audioMessage")} (${Math.round(s.size/1024)}KB)`,sender:r,timestamp:new Date(a.timestamp).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),type:"user",messageType:a.type,audioUrl:c};b([...y,t]);try{await T(n,"Chat Message Sent",`Audio message (${Math.round(s.size/1024)}KB)`)}catch(h){console.error("Failed to log audio message:",h)}}catch(a){console.error("Error sending audio message:",a)}},_=s=>{const a=Math.floor(s/60),c=s%60;return`${a}:${c.toString().padStart(2,"0")}`},G=s=>{const a=s.target.files?.[0];if(a&&a.type.startsWith("image/")){M(a);const c=new FileReader;c.onload=r=>{R(r.target?.result)},c.readAsDataURL(a)}},J=async()=>{if(m)try{if(m.size>10*1024*1024||!["image/jpeg","image/jpg","image/png","image/gif","image/webp"].includes(m.type))return;const a=await re(n,m),c=a.message.startsWith("http")?a.message:`https://portal.wisling.com${a.message}`,r=a.creator?.name||a.sender||o("dashboard.case.chatTab.anonymous","Anonymous"),t={id:a.id,message:`${o("dashboard.case.chatTab.imageMessage")}: ${m.name}`,sender:r,timestamp:new Date(a.timestamp).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),type:"user",messageType:a.type,imageUrl:c,imageName:m.name};b([...y,t]),M(null),R(null);try{await T(n,"Chat Message Sent",`Image: ${m.name}`)}catch(h){console.error("Failed to log image message:",h)}}catch(s){console.error("Error sending image:",s)}},Q=s=>e.jsxs(g,{direction:"row",spacing:2,justifyContent:s.type==="user"?"flex-end":"flex-start",sx:{mb:2},children:[s.type!=="user"&&e.jsx(L,{sx:{width:32,height:32},children:e.jsx(u,{icon:"solar:user-id-bold"})}),e.jsx(te,{sx:{p:2,maxWidth:"70%",backgroundColor:s.type==="user"?"primary.main":"grey.100",color:s.type==="user"?"primary.contrastText":"text.primary"},children:e.jsxs(g,{spacing:1,children:[e.jsxs(g,{direction:"row",spacing:1,alignItems:"center",justifyContent:"space-between",children:[e.jsx(l,{variant:"caption",sx:{fontWeight:600,opacity:s.type==="user"?.9:.8,fontSize:"0.75rem"},children:s.sender}),e.jsx(ce,{size:"small",label:s.messageType==="audio"?o("dashboard.case.chatTab.voice"):s.messageType==="image"?o("dashboard.case.chatTab.imageMessage"):o("dashboard.case.chatTab.text"),icon:e.jsx(u,{icon:s.messageType==="audio"?"solar:microphone-bold":s.messageType==="image"?"solar:gallery-add-bold":"solar:chat-round-dots-bold",width:14}),sx:{fontSize:"0.7rem",height:20,backgroundColor:s.type==="user"?"rgba(255,255,255,0.2)":"rgba(0,0,0,0.1)",color:s.type==="user"?"white":"text.secondary"}})]}),s.messageType==="audio"&&s.audioUrl?e.jsxs(d,{children:[e.jsxs("audio",{controls:!0,style:{width:"100%",maxWidth:"300px"},children:[e.jsx("source",{src:s.audioUrl,type:"audio/wav"}),"Your browser does not support the audio element."]}),e.jsx(l,{variant:"caption",sx:{display:"block",mt:.5,opacity:.7},children:s.message})]}):s.messageType==="image"&&s.imageUrl?e.jsxs(d,{children:[e.jsx("img",{src:s.imageUrl,alt:s.imageName||"Uploaded image",style:{maxWidth:"300px",maxHeight:"200px",borderRadius:"8px",objectFit:"cover"}}),e.jsx(l,{variant:"caption",sx:{display:"block",mt:.5,opacity:.7},children:s.message})]}):e.jsx(l,{variant:"body2",sx:{whiteSpace:"pre-wrap"},children:s.message}),e.jsx(l,{variant:"caption",sx:{display:"block",opacity:.7},children:s.timestamp})]})}),s.type==="user"&&e.jsx(L,{sx:{width:32,height:32},children:e.jsx(u,{icon:"solar:user-id-bold"})})]},s.id);return e.jsxs(ie,{sx:{height:"70vh",display:"flex",flexDirection:"column"},children:[e.jsx(d,{sx:{p:2,borderBottom:1,borderColor:"divider"},children:e.jsx(g,{direction:"row",alignItems:"center",justifyContent:"space-between",children:e.jsx(l,{variant:"h6",children:o("dashboard.case.chatTab.heading")})})}),e.jsx(d,{sx:{flex:1,overflow:"auto",p:2},children:O?e.jsx(d,{sx:{display:"flex",justifyContent:"center",alignItems:"center",minHeight:200},children:e.jsx(l,{variant:"body2",color:"text.secondary",children:o("dashboard.case.chatTab.loadingMessages")})}):y.length===0?e.jsx(d,{sx:{display:"flex",justifyContent:"center",alignItems:"center",minHeight:200},children:e.jsx(l,{variant:"body2",color:"text.secondary",children:o("dashboard.case.chatTab.noMessages")})}):e.jsxs(e.Fragment,{children:[y.map(Q),e.jsx("div",{ref:F})]})}),e.jsxs(d,{sx:{p:2,borderTop:1,borderColor:"divider"},children:[x&&e.jsx(d,{sx:{mb:2},children:e.jsxs(g,{direction:"row",spacing:2,alignItems:"center",children:[e.jsxs(d,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(d,{sx:{width:12,height:12,borderRadius:"50%",backgroundColor:"error.main",animation:"pulse 1.5s infinite","@keyframes pulse":{"0%":{opacity:1},"50%":{opacity:.5},"100%":{opacity:1}}}}),e.jsxs(l,{variant:"body2",color:"error.main",children:[o("dashboard.case.chatTab.recording")," ",_(H)]})]}),e.jsx(N,{sx:{flex:1}}),e.jsx(v,{color:"error",onClick:D,size:"small",children:e.jsx(u,{icon:"solar:copy-bold"})})]})}),V&&e.jsx(d,{sx:{mb:2},children:e.jsxs(g,{direction:"row",spacing:2,alignItems:"center",children:[e.jsx(N,{sx:{flex:1}}),e.jsx(l,{variant:"body2",color:"text.secondary",children:o("dashboard.case.chatTab.processingAudio")||"Processing audio..."})]})}),z&&e.jsx(d,{sx:{mb:2,p:2,border:1,borderColor:"divider",borderRadius:1},children:e.jsxs(g,{direction:"row",spacing:2,alignItems:"center",children:[e.jsx("img",{src:z,alt:"Preview",style:{width:"60px",height:"60px",objectFit:"cover",borderRadius:"4px"}}),e.jsxs(d,{sx:{flex:1},children:[e.jsx(l,{variant:"body2",color:"text.secondary",children:m?.name}),e.jsxs(l,{variant:"caption",color:"text.secondary",children:[(m?.size||0)/1024," KB"]})]}),e.jsxs(g,{direction:"row",spacing:1,children:[e.jsx(K,{size:"small",onClick:J,variant:"contained",children:o("dashboard.case.chatTab.send")}),e.jsx(K,{size:"small",onClick:()=>{M(null),R(null)},children:o("dashboard.case.chatTab.cancel")})]})]})}),e.jsxs(g,{direction:"row",spacing:1,children:[e.jsx(ne,{fullWidth:!0,placeholder:o("dashboard.case.chatTab.typeMessagePlaceholder"),value:C,onChange:s=>E(s.target.value),onKeyPress:q,variant:"outlined",size:"small",multiline:!0,maxRows:3}),e.jsx(S,{title:o("dashboard.case.chatTab.attachImage"),children:e.jsx(v,{color:"default",onClick:()=>W.current?.click(),children:e.jsx(u,{icon:"solar:gallery-add-bold"})})}),e.jsx(S,{title:o(x?"dashboard.case.chatTab.stopRecording":"dashboard.case.chatTab.startRecording"),children:e.jsx(v,{color:x?"error":"default",onClick:x?D:Y,children:e.jsx(u,{icon:x?"solar:copy-bold":"solar:microphone-bold"})})}),e.jsx(S,{title:o("dashboard.case.chatTab.sendMessage"),children:e.jsx(v,{color:"primary",onClick:B,disabled:!C.trim(),children:e.jsx(u,{icon:"custom:send-fill"})})})]}),e.jsx("input",{ref:W,type:"file",accept:"image/*",onChange:G,style:{display:"none"}})]})]})}export{ue as C};
