import{w as z,u as K,a4 as G,r as m,bY as O,x as R,j as s,L as E,p as T,y as k,A as w,B as I,c as F,G as W,e as Y,a7 as H,I as J}from"./index-BJkBHIXD.js";import{a as Q}from"./index.esm-DG78EUPk.js";import{a as X}from"./zod-DbnPk1Kl.js";import{u as Z}from"./use-search-params-BFu-mSGR.js";import{s as d,T as ee,g as se}from"./turnstile-CZ4Z_PxC.js";import{F as L}from"./fields-wQ2IQIfM.js";import{s as M}from"./schema-utils-C_-d4BNQ.js";import{F as ie}from"./form-provider-BYLnCB41.js";import{F as re}from"./form-head-DuwsxQo4.js";import{I as te}from"./InputAdornment-Cyf39fZQ.js";import{o as V,s as h}from"./schemas-BaSQ7w8v.js";import"./text-transform-DM798QSo.js";import"./styles-B-zEs6qR.js";import"./TextField-BfOXJaKd.js";import"./Select-CM-FquqI.js";import"./index-BdCJuPE0.js";import"./rhf-phone-input-DvY4aKGv.js";import"./index-CDpvdXdB.js";import"./search-not-found-BYtFGFNz.js";import"./rhf-text-field-D45rQogC.js";import"./RadioGroup-eX8WPtuC.js";import"./FormControlLabel-Do9AncA_.js";import"./Autocomplete-vOabT0lM.js";import"./Chip-Cd7PxQUv.js";import"./rhf-select-BCHEEYe2.js";import"./upload-default-BMHhCMpu.js";import"./tslib.es6-CTYbIaVE.js";import"./DatePicker-D3hVcc_W.js";import"./Stack-DSqJGNfN.js";import"./format-number-BErDzwe7.js";function ne(e){if(typeof e=="object"&&e!==null){const o=e;if(o.response?.data){const n=o.response.data;if(n.message){if(n.errors&&typeof n.errors=="object"){const c=Object.values(n.errors).flat();if(c.length>0)return`${n.message}: ${c.join(", ")}`}return n.message}if(n.error)return n.error}if(o.httpStatus&&o.message)return o.message;const l=e.message;if(typeof l=="string")return l}return e instanceof Error?e.message||e.name||"An error occurred":typeof e=="string"?e:`Unknown error: ${e}`}const ae=se();function oe(){const{t:e}=z("messages"),o=K(),l=Z(),n=G(),[c,t]=m.useState(null),[v,U]=m.useState(null),[y,f]=m.useState(null),[j,b]=m.useState(!1),[p,u]=m.useState(null);m.useEffect(()=>{const r=l.get("verified");if(r==="1"){U(e("signIn.emailVerified"));const i=new URLSearchParams(l.toString());i.delete("verified");const a=window.location.pathname+(i.toString()?`?${i.toString()}`:"");window.history.replaceState({},"",a)}else if(r==="0"){t(e("signIn.emailVerificationFailed"));const i=new URLSearchParams(l.toString());i.delete("verified");const a=window.location.pathname+(i.toString()?`?${i.toString()}`:"");window.history.replaceState({},"",a)}},[l,e]);const q=V({email:M.email(),password:h().min(1,{message:e("signIn.validation.passwordRequired")}).min(8,{message:e("signIn.validation.passwordMinLength")})}),A={email:"",password:""},P=Q({resolver:X(q),defaultValues:A}),{handleSubmit:$,formState:{isSubmitting:x},watch:D}=P,S=D("email"),N=$(async r=>{try{t(null),f(null),sessionStorage.removeItem("jwt_access_token");const i=d()?p:void 0;if(d()){if(!i){t("Security verification is required. Please complete the verification.");return}if(i.trim()===""){t("Security verification token is invalid. Please refresh and try again."),u(null);return}}const a=await O({email:r.email,password:r.password,turnstileToken:i??void 0});if(a.twoFactorRequired){const g=new URLSearchParams;a.email&&g.set("email",a.email),a.method&&g.set("method",a.method),o.replace(`/auth/two-factor?${g.toString()}`);return}sessionStorage.setItem("just_logged_in","true"),await new Promise(g=>setTimeout(g,100)),window.location.href=R.auth.redirectPath}catch(i){console.error("❌ Login error details:",{error:i,message:i?.message,response:i?.response,responseData:i?.response?.data,httpStatus:i?.httpStatus,errors:i?.errors});const a=ne(i);console.error("❌ Login error message:",a),t(a),u(null)}},r=>{console.error("❌ Form validation failed:",r),t("Please check your input and try again.")}),_=async()=>{if(!S){t(e("signIn.emailAddress")+" is required to resend verification email.");return}try{b(!0),f(null),t(null);const i=(await W.post(Y.auth.resendVerificationEmail,{email:S}))?.message||e("signIn.verificationEmailSent");f(i)}catch(r){console.error("❌ Resend verification email error:",r);const i=r?.response?.data?.message||r?.message||e("signIn.verificationEmailError");t(i),f(null)}finally{b(!1)}},B=c?.toLowerCase().includes("email not verified"),C=()=>s.jsxs(I,{sx:{gap:3,display:"flex",flexDirection:"column"},children:[s.jsx(L.Text,{name:"email",label:e("signIn.emailAddress"),slotProps:{inputLabel:{shrink:!0},htmlInput:{placeholder:e("signIn.emailPlaceholder")}}}),s.jsxs(I,{sx:{gap:1.5,display:"flex",flexDirection:"column"},children:[s.jsx(E,{component:k,href:T.auth.forgotPassword,variant:"body2",color:"inherit",sx:{alignSelf:"flex-end"},children:e("signIn.forgotPassword")}),s.jsx(L.Text,{name:"password",label:e("signIn.password"),placeholder:e("signIn.passwordPlaceholder"),type:n.value?"text":"password",slotProps:{inputLabel:{shrink:!0},input:{endAdornment:s.jsx(te,{position:"end",children:s.jsx(H,{onClick:n.onToggle,edge:"end",children:s.jsx(J,{icon:n.value?"solar:eye-bold":"solar:eye-closed-bold"})})})}}})]}),d()&&s.jsx(ee,{siteKey:ae,onSuccess:r=>{u(r),c?.includes("Security verification")&&t(null)},onError:()=>{console.error("❌ Turnstile verification error"),u(null),t("Security verification failed. Please refresh and try again.")},onExpire:()=>{console.warn("⚠️ Turnstile token expired"),u(null),t("Security verification expired. Please verify again.")},theme:"auto",size:"normal"}),s.jsx(F,{fullWidth:!0,color:"inherit",size:"large",type:"submit",variant:"contained",loading:x,loadingIndicator:e("signIn.signingIn"),disabled:x||d()&&!p,onClick:r=>{if(x||d()&&!p)return d()&&!p&&t("Security verification is required. Please complete the verification."),r.preventDefault(),r.stopPropagation(),!1},children:e("signIn.signInButton")})]});return s.jsxs(s.Fragment,{children:[s.jsx(re,{title:e("signIn.title"),description:s.jsxs(s.Fragment,{children:[`${e("signIn.description")} `,s.jsx(E,{component:k,href:T.signUp,variant:"subtitle2",children:e("signIn.getStarted")})]}),sx:{textAlign:{xs:"center",md:"left"}}}),!!v&&s.jsx(w,{severity:"success",sx:{mb:3},children:v}),!!c&&s.jsxs(w,{severity:"error",sx:{mb:3},children:[c,B&&s.jsx(I,{sx:{mt:2},children:s.jsx(F,{variant:"outlined",size:"small",onClick:_,disabled:j||!S,loading:j,loadingIndicator:e("signIn.resendingVerificationEmail"),children:e("signIn.resendVerificationEmail")})})]}),!!y&&s.jsx(w,{severity:"success",sx:{mb:3},children:y}),s.jsx(ie,{methods:P,onSubmit:N,children:C()})]})}V({firstName:h().min(1,{message:"First name is required!"}),lastName:h().min(1,{message:"Last name is required!"}),email:M.email(),password:h().min(1,{message:"Password is required!"}).min(6,{message:"Password must be at least 6 characters!"})});const le={title:`Sign in | ${R.appName}`};function _e(){return s.jsxs(s.Fragment,{children:[s.jsx("title",{children:le.title}),s.jsx(oe,{})]})}export{_e as default};
