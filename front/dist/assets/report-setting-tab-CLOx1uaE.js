import{w as pe,V as he,r as h,at as be,a0 as j,av as me,au as ue,ae as Y,aC as ge,j as e,B as k,b as xe,T as l,M as s,c as G}from"./index-BJkBHIXD.js";import{a as ye}from"./zod-DbnPk1Kl.js";import{a as Se,F as je}from"./index.esm-DG78EUPk.js";import{f as Te}from"./state-DFemdeiH.js";import{f as fe}from"./severity-Bb8Qe9go.js";import{f as ve}from"./department-BOJZtc9U.js";import"./text-transform-DM798QSo.js";import{R as P}from"./rhf-text-field-D45rQogC.js";import{R as u}from"./rhf-select-BCHEEYe2.js";import"./styles-B-zEs6qR.js";import{C as U}from"./Card-CU8jzKuK.js";import{G as c}from"./Grid-D_Et280v.js";import{S as N}from"./Stack-DSqJGNfN.js";import{o as _e,s as b,n as q}from"./schemas-BaSQ7w8v.js";function Le({caseId:g}){const{t}=pe("navbar"),{user:F}=he(),[$,O]=h.useState(!0),[f,M]=h.useState(!1),[S,J]=h.useState([]),[n,K]=h.useState(null),[T,Q]=h.useState([]),[z,X]=h.useState([]),[I,Z]=h.useState([]),[E,ee]=h.useState([]),ae=_e({assignedTo:b().optional(),assignStatus:b().min(1,t("dashboard.case.reportSettingTab.assignStatusRequired")),openDeadlineNumber:q().nullable().optional(),openDeadlinePeriod:b().nullable().optional(),closeDeadlineNumber:q().nullable().optional(),closeDeadlinePeriod:b().nullable().optional(),linkWithOtherReport:b().nullable().optional(),autoDeleteAfter30Days:b().optional(),category:b().optional(),department:b().optional(),severity:b().optional(),state:b().optional()}),te={assignedTo:"",assignStatus:"new",openDeadlineNumber:null,openDeadlinePeriod:null,closeDeadlineNumber:null,closeDeadlinePeriod:null,linkWithOtherReport:"",autoDeleteAfter30Days:"No",category:"",department:"",severity:"",state:""},A=Se({resolver:ye(ae),defaultValues:te}),{handleSubmit:se,reset:v,formState:{errors:L}}=A,_=h.useCallback(async()=>{try{O(!0);const a=await be(g);if(!a){j.error(t("dashboard.case.reportSettingTab.failedToLoad"));return}K(a);const r=a.company_id||F?.company_id;let m=[];r&&(m=await me(r),J(m));const y=await ue();if(Q(y),r)try{const[d,w,ne]=await Promise.all([ve({per_page:1e3,company_id:r}),fe({per_page:1e3,company_id:r}),Te({per_page:1e3,company_id:r})]),oe=o=>o?.company_id??o?.companyId??o?.company?.id??o?.company?.company_id??o?.company?.companyId??null,B=r?String(r).toLowerCase():null,R=o=>o.filter(ce=>{const H=oe(ce);return B?H?String(H).toLowerCase()===B:!1:!0}),ie=R(d.data?.data??[]).map(o=>({id:o.id,name:o.name})),le=R(w.data?.data??[]).map(o=>({id:o.id,name:o.name})),de=R(ne.data?.data??[]).map(o=>({id:o.id,name:o.name}));X(ie),Z(le),ee(de)}catch(d){console.error("Failed to fetch company-specific options:",d)}let i="";if(a.case_manager_id&&m.length>0){const d=m.find(w=>w.id===a.case_manager_id);i=d?d.name:""}const p=a.open_deadline_number??null,D=a.open_deadline_period??null,x=a.close_deadline_number??null,C=a.close_deadline_period??null,W=y.find(d=>d.name===a.category||d.id===a.category_id),re=W?W.name:a.category||"";v({assignedTo:i,assignStatus:a.status||"new",openDeadlineNumber:p,openDeadlinePeriod:D,closeDeadlineNumber:x,closeDeadlinePeriod:C,linkWithOtherReport:a.other_report_link||"",autoDeleteAfter30Days:a.automatic_delete?"Yes":"No",category:re,department:a.department_id||"",severity:a.severity_id||"",state:a.state_id||""});try{await Y(g,"Tab Viewed","Report Setting Tab (Backend)")}catch(d){console.error("Failed to log tab view:",d)}}catch(a){console.error("Error fetching data:",a),j.error(a.message||t("dashboard.case.reportSettingTab.failedToLoad"))}finally{O(!1)}},[g,F?.company_id,v,t]);h.useEffect(()=>{g&&_()},[g,_]);const V=se(async a=>{try{M(!0);let r=null;if(a.assignedTo){const i=S.find(p=>p.name===a.assignedTo||p.id===a.assignedTo);r=i?i.id:a.assignedTo}let m=null;if(a.category){const i=T.find(p=>p.name===a.category||p.id===a.category);m=i?i.id:a.category}const y={case_manager_id:r,status:a.assignStatus,open_deadline_number:a.openDeadlineNumber??null,open_deadline_period:a.openDeadlinePeriod??null,close_deadline_number:a.closeDeadlineNumber??null,close_deadline_period:a.closeDeadlinePeriod??null,other_report_link:a.linkWithOtherReport||null,automatic_delete:a.autoDeleteAfter30Days==="Yes",case_category_id:m||null,department_id:a.department||null,severity_id:a.severity||null,state_id:a.state||null};await ge(g,y),j.success(t("dashboard.case.reportSettingTab.updatedSuccessfully"));try{await Y(g,"Report Settings Updated",`Status: ${a.assignStatus}`)}catch(i){console.error("Failed to log settings update:",i)}await _()}catch(r){console.error("Form submission error:",r),j.error(r.message||t("dashboard.case.reportSettingTab.failedToUpdate"))}finally{M(!1)}},a=>{console.error("Form validation errors:",a),j.error(t("dashboard.case.reportSettingTab.fixFormErrors"))});return $?e.jsx(U,{sx:{p:3},children:e.jsx(k,{sx:{display:"flex",justifyContent:"center",alignItems:"center",minHeight:200},children:e.jsx(xe,{})})}):e.jsxs(U,{sx:{p:3},children:[e.jsx(l,{variant:"h6",gutterBottom:!0,sx:{py:1.5},children:t("dashboard.case.reportSettingTab.heading")}),e.jsxs(je,{...A,children:[e.jsx("form",{onSubmit:V,children:e.jsxs(c,{container:!0,spacing:3,children:[e.jsx(c,{size:{xs:12,sm:6},children:e.jsx(u,{name:"assignedTo",label:t("dashboard.case.reportSettingTab.assignTo"),placeholder:t("dashboard.case.reportSettingTab.selectCaseManager"),children:S.length===0?e.jsx(s,{value:"",disabled:!0,children:e.jsx(l,{variant:"body2",color:"text.secondary",children:t("dashboard.case.reportSettingTab.loadingCaseManagers")})}):S.map(a=>e.jsx(s,{value:a.name,children:a.name},a.id))})}),e.jsx(c,{size:{xs:12,sm:6},children:e.jsxs(u,{name:"assignStatus",label:t("dashboard.case.reportSettingTab.assignStatus"),placeholder:t("dashboard.case.reportSettingTab.selectStatus"),children:[e.jsx(s,{value:"new",children:t("dashboard.case.reportSettingTab.new")}),e.jsx(s,{value:"open",children:t("dashboard.case.reportSettingTab.open")}),e.jsx(s,{value:"in_progress",children:t("dashboard.case.reportSettingTab.inProgress")}),e.jsx(s,{value:"closed",children:t("dashboard.case.reportSettingTab.closed")}),e.jsx(s,{value:"pending",children:t("dashboard.case.reportSettingTab.pending")}),e.jsx(s,{value:"resolved",children:t("dashboard.case.reportSettingTab.resolved")}),e.jsx(s,{value:"rejected",children:t("dashboard.case.reportSettingTab.rejected")}),e.jsx(s,{value:"cancelled",children:t("dashboard.case.reportSettingTab.cancelled")}),e.jsx(s,{value:"spam",children:t("dashboard.case.reportSettingTab.spam")}),e.jsx(s,{value:"other",children:t("dashboard.case.reportSettingTab.other")})]})}),e.jsxs(c,{size:{xs:12,sm:6},children:[e.jsx(l,{variant:"subtitle2",sx:{mb:1},children:t("dashboard.case.reportSettingTab.nextOpenStateDeadline")}),e.jsxs(N,{direction:"row",spacing:2,children:[e.jsx(P,{name:"openDeadlineNumber",type:"number",placeholder:"0",sx:{flex:1},slotProps:{htmlInput:{min:0}}}),e.jsxs(u,{name:"openDeadlinePeriod",placeholder:t("dashboard.case.reportSettingTab.selectPeriod"),sx:{flex:1},children:[e.jsx(s,{value:"daily",children:t("dashboard.case.reportSettingTab.daily")}),e.jsx(s,{value:"weekly",children:t("dashboard.case.reportSettingTab.weekly")}),e.jsx(s,{value:"monthly",children:t("dashboard.case.reportSettingTab.monthly")}),e.jsx(s,{value:"yearly",children:t("dashboard.case.reportSettingTab.yearly")})]})]}),e.jsx(l,{variant:"caption",color:"text.secondary",sx:{mt:.5},children:t("dashboard.case.reportSettingTab.nextOpenStateDeadlineHelper")})]}),e.jsxs(c,{size:{xs:12,sm:6},children:[e.jsx(l,{variant:"subtitle2",sx:{mb:1},children:t("dashboard.case.reportSettingTab.nextCloseStateDeadline")}),e.jsxs(N,{direction:"row",spacing:2,children:[e.jsx(P,{name:"closeDeadlineNumber",type:"number",placeholder:"0",sx:{flex:1},slotProps:{htmlInput:{min:0}}}),e.jsxs(u,{name:"closeDeadlinePeriod",placeholder:t("dashboard.case.reportSettingTab.selectPeriod"),sx:{flex:1},children:[e.jsx(s,{value:"daily",children:t("dashboard.case.reportSettingTab.daily")}),e.jsx(s,{value:"weekly",children:t("dashboard.case.reportSettingTab.weekly")}),e.jsx(s,{value:"monthly",children:t("dashboard.case.reportSettingTab.monthly")}),e.jsx(s,{value:"yearly",children:t("dashboard.case.reportSettingTab.yearly")})]})]}),e.jsx(l,{variant:"caption",color:"text.secondary",sx:{mt:.5},children:t("dashboard.case.reportSettingTab.nextCloseStateDeadlineHelper")})]}),e.jsx(c,{size:{xs:12,sm:6},children:e.jsx(P,{name:"linkWithOtherReport",label:t("dashboard.case.reportSettingTab.linkWithOtherReport"),placeholder:t("dashboard.case.reportSettingTab.linkWithOtherReportPlaceholder")})}),e.jsx(c,{size:{xs:12,sm:6},children:e.jsxs(u,{name:"autoDeleteAfter30Days",label:t("dashboard.case.reportSettingTab.autoDeleteAfter30Days"),placeholder:t("dashboard.case.reportSettingTab.selectOption"),children:[e.jsx(s,{value:"Yes",children:t("dashboard.case.reportSettingTab.yes")}),e.jsx(s,{value:"No",children:t("dashboard.case.reportSettingTab.no")})]})}),e.jsx(c,{size:{xs:12,sm:6},children:e.jsx(u,{name:"category",label:t("dashboard.case.caseDetailsTab.category"),placeholder:t("dashboard.case.caseDetailsTab.select"),children:T.length===0?e.jsx(s,{value:"",disabled:!0,children:e.jsx(l,{variant:"body2",color:"text.secondary",children:t("dashboard.case.caseDetailsTab.loading")})}):T.map(a=>e.jsx(s,{value:a.name,children:a.name},a.id))})}),e.jsx(c,{size:{xs:12,sm:6},children:e.jsx(u,{name:"department",label:t("dashboard.case.caseDetailsTab.department"),placeholder:t("dashboard.case.caseDetailsTab.select"),slotProps:{inputLabel:{shrink:!0}},children:z.length===0?e.jsx(s,{value:"",disabled:!0,children:e.jsx(l,{variant:"body2",color:"text.secondary",children:t("dashboard.case.caseDetailsTab.loading")})}):z.map(a=>e.jsx(s,{value:a.id,children:a.name},a.id))})}),e.jsx(c,{size:{xs:12,sm:6},children:e.jsx(u,{name:"severity",label:t("dashboard.case.caseDetailsTab.severity"),placeholder:t("dashboard.case.caseDetailsTab.select"),slotProps:{inputLabel:{shrink:!0}},children:I.length===0?e.jsx(s,{value:"",disabled:!0,children:e.jsx(l,{variant:"body2",color:"text.secondary",children:t("dashboard.case.caseDetailsTab.loading")})}):I.map(a=>e.jsx(s,{value:a.id,children:a.name},a.id))})}),e.jsx(c,{size:{xs:12,sm:6},children:e.jsx(u,{name:"state",label:t("dashboard.case.caseDetailsTab.state"),placeholder:t("dashboard.case.caseDetailsTab.select"),children:E.length===0?e.jsx(s,{value:"",disabled:!0,children:e.jsx(l,{variant:"body2",color:"text.secondary",children:t("dashboard.case.caseDetailsTab.loading")})}):E.map(a=>e.jsx(s,{value:a.id,children:a.name},a.id))})})]})}),Object.keys(L).length>0&&e.jsxs(k,{sx:{mt:2,p:2,bgcolor:"error.lighter",borderRadius:1},children:[e.jsx(l,{variant:"body2",color:"error.main",children:t("dashboard.case.reportSettingTab.pleaseFixErrors")}),e.jsx(k,{component:"ul",sx:{mt:1,pl:2},children:Object.entries(L).map(([a,r])=>e.jsx("li",{children:e.jsxs(l,{variant:"caption",color:"error.main",children:[a,": ",r?.message||t("dashboard.case.reportSettingTab.invalidValue")]})},a))})]}),e.jsxs(N,{direction:"row",justifyContent:"flex-end",spacing:2,sx:{mt:3},children:[e.jsx(G,{variant:"outlined",disabled:f,onClick:()=>{if(n){const a=n.open_deadline_number??null,r=n.open_deadline_period??null,m=n.close_deadline_number??null,y=n.close_deadline_period??null;let i="";if(n.case_manager_id&&S.length>0){const x=S.find(C=>C.id===n.case_manager_id);i=x?x.name:""}const p=T.find(x=>x.name===n.category||x.id===n.category_id),D=p?p.name:n.category||"";v({assignedTo:i,assignStatus:n.status||"new",openDeadlineNumber:a,openDeadlinePeriod:r,closeDeadlineNumber:m,closeDeadlinePeriod:y,linkWithOtherReport:n.other_report_link||"",autoDeleteAfter30Days:n.automatic_delete?"Yes":"No",category:D,department:n.department_id||"",severity:n.severity_id||"",state:n.state_id||""})}},children:t("dashboard.case.reportSettingTab.cancel")}),e.jsx(G,{type:"button",variant:"contained",disabled:f,onClick:a=>{a.preventDefault(),V(a)},children:t(f?"dashboard.case.reportSettingTab.saving":"dashboard.case.reportSettingTab.saveChanges")})]})]})]})}export{Le as R};
